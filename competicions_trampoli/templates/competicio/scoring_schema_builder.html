{% extends "base.html" %}
{% block title %}Puntuaci√≥ ‚Äì {{ aparell.nom }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .pill-help{ font-size:.85rem; color:#6c757d; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table td, .table th{ vertical-align:middle; }
    .w-120{ width:120px; }
    .w-140{ width:140px; }
    .w-160{ width:160px; }
    .w-200{ width:200px; }
    .badge-soft{ background:#f1f3f5; border:1px solid #e9ecef; }
    .d-none{ display:none !important; }

    .help-card{
      border:1px solid #dbeafe;
      background:#eff6ff;
      border-radius:.5rem;
      padding:.75rem .9rem;
    }
    .step-card{
      border:1px solid #e9ecef;
      border-radius:.5rem;
      padding:.75rem .9rem;
      background:#fff;
    }
    .step-title{
      font-weight:700;
      margin-bottom:.25rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .step-badge{
      font-size:.75rem;
      background:#f8f9fa;
      border:1px solid #e9ecef;
      border-radius:999px;
      padding:.1rem .5rem;
      color:#495057;
    }
    .hint{
      font-size:.85rem;
      color:#6c757d;
      margin-bottom:.5rem;
    }
    .microflow{
      font-size:.85rem;
      color:#495057;
      background:#f8f9fa;
      border:1px solid #e9ecef;
      border-radius:.5rem;
      padding:.5rem .6rem;
      margin-top:.5rem;
    }
    .microflow .mono{ font-size:.82rem; }
    details summary{ cursor:pointer; }
    .card-surface input:not([type="checkbox"]):not([type="radio"]),
    .card-surface select,
    .card-surface textarea,
    .card-surface .form-control {
  width: 100%;
}
  .card-surface .form-check-input { width: auto; }

  </style>

  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-1">Puntuaci√≥ ¬∑ {{ aparell.nom }}</h2>
      {% if competicio %}
        <div class="text-muted small">Competici√≥: <strong>{{ competicio.nom }}</strong></div>
      {% endif %}
        <div class="text-muted small">Configura camps i f√≥rmules sense escriure JSON.</div>
      </div>
    </div>

    <form method="post" id="schemaForm">
      {% csrf_token %}

      {% if form.errors %}
      {% if form.schema_json.errors %}
        <div class="alert alert-danger">
          <div class="fw-bold mb-2">Errors de validaci√≥ de l‚Äôschema</div>
          <ul class="mb-0">
            {% for e in form.schema_json.errors %}
              <li>{{ e }}</li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <pre class="alert alert-warning" style="white-space: pre-wrap;">{{ form.errors }}</pre>
      {% endif %}
      {% endif %}

      {{ form.schema_json }}

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-toggle="tab" href="#tab-fields" role="tab">Camps</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#tab-formules" role="tab">F√≥rmules</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#tab-advanced" role="tab">Avan√ßat (JSON)</a>
        </li>
      </ul>

      <div class="tab-content pt-3">
        <!-- CAMPS -->
        <div class="tab-pane fade show active" id="tab-fields" role="tabpanel">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="font-weight-bold">Camps d‚Äôentrada</div>
                <div class="pill-help">
                  Defineix qu√® omplir√† el jurat. Els criteris d‚Äôagregaci√≥/selecci√≥ es defineixen a <strong>F√≥rmules</strong>.
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddField">Afegir camp</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-bordered" id="fieldsTable">
                <thead class="thead-light">
                  <tr>
                    <th>Etiqueta</th>
                    <th class="w-120">Code</th>
                    <th class="w-120">Var</th>

                    <th class="w-120">Jutges</th>
                    <th class="w-120">√çtems</th>

                    <th class="w-120">Min</th>
                    <th class="w-120">Max</th>
                    <th class="w-120">Decimals</th>

                    <th class="w-120">Crash</th>
                    <th class="w-120"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- F√íRMULES -->
        <div class="tab-pane fade" id="tab-formules" role="tabpanel">
          <div class="border rounded p-3">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="font-weight-bold">F√≥rmules (camps calculats)</div>
                <div class="pill-help">
                  Tria una <strong>funci√≥ guiada</strong> (Row/Column compute) o una <strong>f√≥rmula manual</strong>.
                  Les f√≥rmules s‚Äôavaluen <strong>de dalt a baix</strong>.
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddComputed">Afegir f√≥rmula</button>
            </div>

            <!-- AJUDA (inspirada en classificacions: clara, sense jerga) -->
            <div class="help-card small mb-3">
              <div class="font-weight-bold mb-1">‚ÑπÔ∏è Com funcionen les f√≥rmules (explicaci√≥ simple)</div>

              <div class="mb-2">
                Una f√≥rmula crea una <strong>nota final</strong> a partir dels camps d‚Äôentrada i/o altres f√≥rmules.
                Si no vols programar, usa <strong>Row compute</strong> o <strong>Column compute</strong>.
              </div>

              <ul class="pl-3 mb-2">
                <li>
                  <strong>F√≥rmula manual</strong>: escriu una expressi√≥ amb els codes (ex: <span class="mono">E_total + DD - P</span>).
                </li>
                <li>
                  <strong>Row compute</strong> (row_custom_compute):<br>
                  <span class="text-muted">
                    primer calcula <em>dins de cada jutge</em> (sobre els √≠tems) i despr√©s combina <em>entre jutges</em>.
                  </span>
                </li>
                <li>
                  <strong>Column compute</strong> (column_custom_compute):<br>
                  <span class="text-muted">
                    primer calcula <em>dins de cada √≠tem/aspecte</em> (sobre els jutges) i despr√©s combina <em>entre √≠tems</em>.
                  </span>
                </li>
              </ul>

              <div class="text-muted">
                üí° Consell: si dubtes, comen√ßa per <strong>Row compute</strong> (√©s el m√©s habitual quan cada jutge t√© una ‚Äúfila‚Äù d‚Äô√≠tems).
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-bordered" id="computedTable">
                <thead class="thead-light">
                  <tr>
                    <th>Etiqueta</th>
                    <th class="w-140">Code</th>
                    <th class="w-120">Var</th>
                    <th class="w-200">Funci√≥</th>
                    <th>Configuraci√≥ / F√≥rmula</th>
                    <th class="w-120"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- AVAN√áAT JSON -->
        <div class="tab-pane fade" id="tab-advanced" role="tabpanel">
          <div class="border rounded p-3">
            <div class="font-weight-bold mb-2">Avan√ßat (JSON)</div>
            <div class="pill-help mb-2">JSON generat autom√†ticament pel builder (nom√©s lectura).</div>
            <textarea id="advancedJson" class="form-control mono" rows="18" readonly></textarea>
          </div>
        </div>
      </div>

      <div class="gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Desar</button>
        <a class="btn btn-outline-secondary" href="{{ next|default:request.META.HTTP_REFERER }}">Cancel¬∑lar</a>
      </div>
    </form>
  </div>
</div>

{{ schema_initial|json_script:"schema-initial" }}

<script>
  // --- Schema inicial ---
  let schema = {};
  try { schema = JSON.parse(document.getElementById("schema-initial").textContent || "{}"); }
  catch (e) { schema = {}; }

  // --- Helpers ---
  function uid(){ return Math.random().toString(16).slice(2); }
  function qs(sel){ return document.querySelector(sel); }

  function showIf(el, yes){
    if(!el) return;
    el.classList.toggle("d-none", !yes);
  }

  function needsN(method){
    return (method === "best_n" || method === "worst_n" || method === "drop_extremes_until_n");
  }

  // --- Select options ---
  const PRESET_FUNCS = [
    ["manual", "F√≥rmula manual (escriure expressi√≥)"],
    ["row_compute", "Row compute (guiada ¬∑ per jutge ‚Üí entre jutges)"],
    ["column_compute", "Column compute (guiada ¬∑ per √≠tem ‚Üí entre √≠tems)"],
    ["exec_trampoli", "Execuci√≥ trampol√≠ (E_j) (guiada)"],
  ];

  const SELECT_OPTIONS = [
    ["all", "Tots (no seleccionar)"],
    ["drop_extremes", "Eliminar extrems (min i max)"],
    ["drop_extremes_until_n", "Eliminar extrems alternant fins N"],
    ["best_n", "Millors N"],
    ["worst_n", "Pitjors N"],
  ];

  const AGG_OPTIONS = [
    ["sum", "Suma"],
    ["avg", "Mitjana"],
    ["med", "Mediana"],
    ["min", "M√≠nim"],
    ["max", "M√†xim"],
  ];

  const SELECT_ON_OPTIONS = [
    ["expr", "Sobre el resultat calculat (item_expr)"],
    ["raw",  "Sobre el valor original (x)"],
  ];

  function optionHTML(opts){
    return opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join("");
  }

  function allCodes(){
    const codes = [];
    document.querySelectorAll("#fieldsTable tbody tr").forEach(r=>{
      const c = r.querySelector('[data-k="code"]').value.trim();
      if(c) codes.push(c);
    });
    document.querySelectorAll("#computedTable tbody tr").forEach(r=>{
      const c = r.querySelector('[data-k="code"]').value.trim();
      if(c) codes.push(c);
    });
    return Array.from(new Set(codes));
  }

  /* =========================
     CAMPS
     ========================= */
  function fieldRow(data){
    const tr = document.createElement("tr");
    tr.dataset.id = uid();
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" data-k="label" value="${data.label||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="code" value="${data.code||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="var" value="${data.var||""}"></td>

      <td><input class="form-control form-control-sm" data-k="judges_count" value="${data.judges_count ?? ""}" placeholder="ex: 3"></td>
      <td><input class="form-control form-control-sm" data-k="items_count" value="${data.items_count ?? ""}" placeholder="ex: 11"></td>

      <td><input class="form-control form-control-sm" data-k="min" value="${data.min ?? ""}"></td>
      <td><input class="form-control form-control-sm" data-k="max" value="${data.max ?? ""}"></td>
      <td><input class="form-control form-control-sm" data-k="decimals" value="${data.decimals ?? ""}"></td>

      <td class="text-center">
        <input type="checkbox" data-k="crash_enabled">
      </td>

      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger">Eliminar</button>
      </td>
    `;

    tr.querySelector('input[data-k="crash_enabled"]').checked = !!data.crash_enabled;

    tr.querySelector("button").addEventListener("click", ()=>{
      tr.remove();
      refreshAll();
    });

    tr.querySelectorAll("input,select").forEach(i=>{
      i.addEventListener("input", refreshAll);
      i.addEventListener("change", refreshAll);
    });

    return tr;
  }

  /* =========================
     COMPUTED: UI ‚Äúclar‚Äù per row_custom / column_custom
     ========================= */
  function computedRow(data){
    const tr = document.createElement("tr");
    tr.dataset.id = uid();

    const preset = data.preset || data.builder?.preset || "manual";
    const postId = "postEnabled_" + uid();

    tr.innerHTML = `
      <td><input class="form-control form-control-sm" data-k="label" value="${data.label||""}" placeholder="Etiqueta"></td>
      <td><input class="form-control form-control-sm mono" data-k="code" value="${data.code||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="var" value="${data.var||""}"></td>

      <td>
        <select class="form-control form-control-sm" data-k="preset">
          ${optionHTML(PRESET_FUNCS)}
        </select>
        <div class="pill-help mt-1">
          Tria una funci√≥ guiada o manual.
        </div>
      </td>

      <td>
        <!-- MANUAL -->
        <div data-box="manual">
          <input class="form-control form-control-sm mono" data-k="manual_formula"
                 value="${data.formula||""}"
                 placeholder="Ex: E_total + DD + TOF + HD - P">
          <div class="pill-help mt-1">
            Escriu una expressi√≥ amb els <strong>codes</strong> (ex: <span class="mono">E_total</span>, <span class="mono">DD</span>‚Ä¶).
          </div>
        </div>

        <!-- ROW/COLUMN COMPUTE (mateixa UI, canvia el text i el mapping intern) -->
        <div data-box="rc_compute" class="d-none">

          <!-- CONFIGURACI√ì GLOBAL (no √©s una fase) -->
          <div class="step-card mb-2">
            <div class="step-title">
              <span class="step-badge">Global</span>
              <span data-k="rc_global_title">Configuraci√≥ global</span>
            </div>
            <div class="hint" data-k="rc_global_help"></div>

            <div class="row">
              <div class="col-md-3 mb-2">
                <label class="small text-muted mb-1">Camp font (matriu)</label>
                <select class="form-control form-control-sm mono" data-k="rc_source"></select>
                <div class="pill-help mt-1">Tria el camp que cont√© la matriu (jutges √ó √≠tems).</div>
              </div>

              <div class="col-md-4 mb-2">
                <label class="small text-muted mb-1">Transformaci√≥ per valor (item_expr)</label>
                <input class="form-control form-control-sm mono" data-k="rc_item_expr" placeholder="Ex: x   o   1 - x">
                <div class="pill-help mt-1">
                  Es calcula <strong>sempre</strong> per cada valor abans de seleccionar/agregar.
                  Variables: <span class="mono">x</span> (valor) i <span class="mono">i</span> (√≠ndex d‚Äô√≠tem 1..N).
                </div>
              </div>

              <div class="col-md-3 mb-2">
                <label class="small text-muted mb-1">Rang d‚Äô√≠tems</label>
                <div class="d-flex" style="gap:6px;">
                  <input class="form-control form-control-sm" data-k="rc_start" placeholder="start" value="1">
                  <input class="form-control form-control-sm" data-k="rc_count" placeholder="count (opcional)">
                </div>
                <div class="pill-help mt-1">Si ho deixes buit, s‚Äôusen tots els √≠tems (i es respecta el crash si el camp el t√©).</div>
              </div>

              <div class="col-md-2 mb-2">
                <label class="small text-muted mb-1">Preview</label>
                <input class="form-control form-control-sm mono" data-k="rc_preview" readonly>
              </div>
            </div>

            <div class="microflow" data-k="rc_microflow"></div>
          </div>

          <!-- FASE INTERNA -->
          <div class="step-card mb-2">
            <div class="step-title">
              <span class="step-badge">Fase interna</span>
              <span data-k="rc_internal_title">‚Äî</span>
            </div>
            <div class="hint" data-k="rc_internal_help"></div>

            <div class="row">
              <div class="col-md-5 mb-2">
                <label class="small text-muted mb-1" data-k="rc_internal_select_lbl">Selecci√≥</label>
                <select class="form-control form-control-sm" data-k="rc_internal_select">
                  ${optionHTML(SELECT_OPTIONS)}
                </select>
                <input class="form-control form-control-sm mt-1 d-none" data-k="rc_internal_n" placeholder="N (si aplica)">
                <div class="pill-help mt-1">Exemples: ‚ÄúEliminar extrems‚Äù o ‚ÄúMillors N‚Äù.</div>
              </div>

              <div class="col-md-4 mb-2">
                <label class="small text-muted mb-1">Agregaci√≥</label>
                <select class="form-control form-control-sm" data-k="rc_internal_agg">
                  ${optionHTML(AGG_OPTIONS)}
                </select>
                <div class="pill-help mt-1">Exemple: Mitjana, Suma, Mediana‚Ä¶</div>
              </div>

              <div class="col-md-3 mb-2">
                <label class="small text-muted mb-1">Opcions</label>
                <details>
                  <summary class="small text-muted">Avan√ßat (opcional)</summary>
                  <div class="mt-2">
                    <div class="pill-help mb-1">
                      <strong>Sobre qu√® decideixo i agrego?</strong><br>
                      Normalment treballar√†s sobre el resultat calculat (<span class="mono">item_expr</span>).
                    </div>

                    <label class="small text-muted mb-1">Selecciona segons</label>
                    <select class="form-control form-control-sm" data-k="rc_internal_select_on">
                      ${optionHTML(SELECT_ON_OPTIONS)}
                    </select>

                    <label class="small text-muted mb-1 mt-2">Agrega sobre</label>
                    <select class="form-control form-control-sm" data-k="rc_internal_agg_on">
                      ${optionHTML(SELECT_ON_OPTIONS)}
                    </select>

                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" data-k="rc_internal_post_enabled"  id="${postId}">
                      <label class="form-check-label" for="${postId}">
                        Transformar el resultat intern (post(m))
                      </label>
                    </div>

                    <input class="form-control form-control-sm mono mt-2 d-none"
                           data-k="rc_internal_post_expr"
                           placeholder="Ex: 1 - m   (m = resultat intern)">

                    <div class="pill-help mt-1 d-none" data-k="rc_internal_post_help">
                      <span class="mono">m</span> √©s el resultat despr√©s de la selecci√≥+agregaci√≥ interna.
                      Exemple t√≠pic: <span class="mono">1 - m</span> per invertir una escala 0..1.
                    </div>
                  </div>
                </details>
              </div>
            </div>
          </div>

          <!-- FASE FINAL -->
          <div class="step-card">
            <div class="step-title">
              <span class="step-badge">Fase final</span>
              <span data-k="rc_final_title">‚Äî</span>
            </div>
            <div class="hint" data-k="rc_final_help"></div>

            <div class="row">
              <div class="col-md-5 mb-2">
                <label class="small text-muted mb-1" data-k="rc_final_select_lbl">Selecci√≥</label>
                <select class="form-control form-control-sm" data-k="rc_final_select">
                  ${optionHTML(SELECT_OPTIONS)}
                </select>
                <input class="form-control form-control-sm mt-1 d-none" data-k="rc_final_n" placeholder="N (si aplica)">
                <div class="pill-help mt-1">Aqu√≠ combines els resultats de la fase interna.</div>
              </div>

              <div class="col-md-4 mb-2">
                <label class="small text-muted mb-1">Agregaci√≥ final</label>
                <select class="form-control form-control-sm" data-k="rc_final_agg">
                  ${optionHTML(AGG_OPTIONS)}
                </select>
              </div>

              <div class="col-md-3 mb-2">
                <label class="small text-muted mb-1">Opcions</label>
                <details>
                  <summary class="small text-muted">Avan√ßat (opcional)</summary>
                  <div class="mt-2">
                    <label class="small text-muted mb-1">Transformaci√≥ final (post_final_expr)</label>
                    <input class="form-control form-control-sm mono" data-k="rc_post_final_expr"
                           placeholder="Ex: m   o   1 - m   (m = resultat final)">
                    <div class="pill-help mt-1">
                      S‚Äôaplica al final de tot. <span class="mono">m</span> √©s el resultat final.
                    </div>
                  </div>
                </details>
              </div>
            </div>
          </div>

        </div>

        <!-- EXEC_TRAMPOLI (E_j) -->
        <div data-box="exec_trampoli" class="border rounded p-2 d-none">
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Camp Execuci√≥ (matriu)</label>
              <select class="form-control form-control-sm mono" data-k="et_source"></select>
              <div class="pill-help mt-1">Genera una llista ‚Äúper jutge‚Äù.</div>
            </div>
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Crash del camp</label>
              <input class="form-control form-control-sm mono" data-k="et_crash_code" placeholder="Ex: E" value="">
              <div class="pill-help mt-1">Normalment √©s el mateix codi (Ex: <span class="mono">E</span>).</div>
            </div>
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Preview f√≥rmula</label>
              <input class="form-control form-control-sm mono" data-k="et_preview" readonly>
            </div>
          </div>
        </div>

        <!-- F√≥rmula real que es guarda -->
        <input type="hidden" data-k="formula" value="${data.formula||""}">
      </td>

      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger">Eliminar</button></td>
    `;

    // preset init
    tr.querySelector('select[data-k="preset"]').value = preset;

    // delete
    tr.querySelector("button").addEventListener("click", ()=>{
      tr.remove();
      refreshAll();
    });

    // hydrate builder (compat amb l‚Äôesquema anterior)
    const b = data.builder || {};
    if (preset === "row_compute" || preset === "column_compute") {
      tr.querySelector('[data-k="rc_item_expr"]').value = b.item_expr || "";

      // mapping: intern/final dep√®n del preset
      const internalSel = (preset === "row_compute") ? (b.row_select || "all") : (b.col_select || "all");
      const internalAgg = (preset === "row_compute") ? (b.row_agg || "sum") : (b.col_agg || "sum");
      const internalN   = (preset === "row_compute") ? (b.row_select_n) : (b.col_select_n);

      const finalSel = (preset === "row_compute") ? (b.col_select || "all") : (b.row_select || "all");
      const finalAgg = (preset === "row_compute") ? (b.col_agg || "sum") : (b.row_agg || "sum");
      const finalN   = (preset === "row_compute") ? (b.col_select_n) : (b.row_select_n);

      tr.querySelector('[data-k="rc_internal_select"]').value = internalSel;
      tr.querySelector('[data-k="rc_internal_agg"]').value = internalAgg;
      if (internalN != null) tr.querySelector('[data-k="rc_internal_n"]').value = internalN;

      tr.querySelector('[data-k="rc_final_select"]').value = finalSel;
      tr.querySelector('[data-k="rc_final_agg"]').value = finalAgg;
      if (finalN != null) tr.querySelector('[data-k="rc_final_n"]').value = finalN;

      tr.querySelector('[data-k="rc_start"]').value = (b.start ?? 1) + "";
      tr.querySelector('[data-k="rc_count"]').value = (b.count ?? "") + "";

      // avan√ßat intern: (select_on / agg_on / post_agg_expr)
      const internalSelectOn = (preset === "row_compute") ? (b.row_select_on || "raw") : (b.col_select_on || "raw");
      const internalAggOn    = (preset === "row_compute") ? (b.row_agg_on || "expr") : (b.col_select_on || "expr"); // en el teu JS vell, column reutilitzava col_select_on com agg_on
      const internalPostExpr = (preset === "row_compute") ? (b.row_post_agg_expr || "") : (b.col_post_agg_expr || "");

      tr.querySelector('[data-k="rc_internal_select_on"]').value = internalSelectOn;
      tr.querySelector('[data-k="rc_internal_agg_on"]').value = internalAggOn;

      const postEnabled = !!internalPostExpr;
      tr.querySelector('[data-k="rc_internal_post_enabled"]').checked = postEnabled;
      tr.querySelector('[data-k="rc_internal_post_expr"]').value = internalPostExpr || "";

      tr.querySelector('[data-k="rc_post_final_expr"]').value = (b.post_final_expr || "");
    }

    if (preset === "exec_trampoli") {
      tr.querySelector('[data-k="et_crash_code"]').value = (b.crash_code || "") + "";
    }

    // events
    tr.querySelectorAll("input,select,details").forEach(i=>{
      i.addEventListener("input", refreshAll);
      i.addEventListener("change", refreshAll);
      i.addEventListener("toggle", refreshAll);
    });

    return tr;
  }

  function updateComputedRowUI(tr){
    const preset = tr.querySelector('[data-k="preset"]').value;

    const boxManual = tr.querySelector('[data-box="manual"]');
    const boxRC     = tr.querySelector('[data-box="rc_compute"]');
    const boxET     = tr.querySelector('[data-box="exec_trampoli"]');

    showIf(boxManual, preset === "manual");
    showIf(boxRC, (preset === "row_compute" || preset === "column_compute"));
    showIf(boxET, preset === "exec_trampoli");

    // MANUAL: nom√©s guardar el que s‚Äôescriu
    if(preset === "manual"){
      const mf = tr.querySelector('[data-k="manual_formula"]').value.trim();
      tr.querySelector('[data-k="formula"]').value = mf;
      return;
    }

    // EXEC TRAMPOLI
    if(preset === "exec_trampoli"){
      const codes = allCodes();
      const sel = tr.querySelector('[data-k="et_source"]');
      const current = sel.value || "";
      sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join("");
      sel.value = (codes.includes(current) ? current : (codes[0] || ""));

      const src = sel.value || "";
      const crashCode = (tr.querySelector('[data-k="et_crash_code"]').value.trim() || src);

      const formula = `exec_by_judge(${src}, crash('${crashCode}'), params)`;
      tr.querySelector('[data-k="formula"]').value = formula;
      tr.querySelector('[data-k="et_preview"]').value = formula;
      return;
    }

    // ROW/COLUMN COMPUTE
    if(preset === "row_compute" || preset === "column_compute"){
      const codes = allCodes();

      // source select
      const sel = tr.querySelector('[data-k="rc_source"]');
      const current = sel.value || "";
      sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join("");
      sel.value = (codes.includes(current) ? current : (codes[0] || ""));

      // texts segons preset (per fer-ho mentalment f√†cil)
      const gTitle = tr.querySelector('[data-k="rc_global_title"]');
      const gHelp  = tr.querySelector('[data-k="rc_global_help"]');
      const iTitle = tr.querySelector('[data-k="rc_internal_title"]');
      const iHelp  = tr.querySelector('[data-k="rc_internal_help"]');
      const fTitle = tr.querySelector('[data-k="rc_final_title"]');
      const fHelp  = tr.querySelector('[data-k="rc_final_help"]');
      const flow   = tr.querySelector('[data-k="rc_microflow"]');

      if (preset === "row_compute"){
        gHelp.textContent = "Aquesta funci√≥ calcula primer dins de cada jutge (sobre els √≠tems) i despr√©s combina els jutges.";
        iTitle.textContent = "Dins de cada jutge (√≠tems/aspectes)";
        iHelp.textContent = "Aqu√≠ decideixes com seleccionar √≠tems i com agregar-los per obtenir 1 resultat per jutge.";
        fTitle.textContent = "Entre jutges (resultat final)";
        fHelp.textContent = "Aqu√≠ combines els resultats dels jutges per obtenir la nota final.";
        flow.innerHTML = `
          <div>Flux:</div>
          <div class="mono">
            per cada jutge ‚Üí per cada √≠tem: y = item_expr(x,i)
            ‚Üí selecci√≥ √≠tems ‚Üí agregaci√≥ ‚Üí (resultat per jutge)
            ‚Üí selecci√≥ jutges ‚Üí agregaci√≥ final
          </div>`;
      } else {
        gHelp.textContent = "Aquesta funci√≥ calcula primer dins de cada √≠tem (sobre els jutges) i despr√©s combina els √≠tems.";
        iTitle.textContent = "Dins de cada √≠tem/aspecte (jutges)";
        iHelp.textContent = "Aqu√≠ decideixes com seleccionar jutges i com agregar-los per obtenir 1 resultat per √≠tem.";
        fTitle.textContent = "Entre √≠tems/aspectes (resultat final)";
        fHelp.textContent = "Aqu√≠ combines els resultats dels √≠tems per obtenir la nota final.";
        flow.innerHTML = `
          <div>Flux:</div>
          <div class="mono">
            per cada √≠tem ‚Üí per cada jutge: y = item_expr(x,i)
            ‚Üí selecci√≥ jutges ‚Üí agregaci√≥ ‚Üí (resultat per √≠tem)
            ‚Üí selecci√≥ √≠tems ‚Üí agregaci√≥ final
          </div>`;
      }

      // valors UI
      const itemExpr = (tr.querySelector('[data-k="rc_item_expr"]').value.trim() || "x");
      const start = tr.querySelector('[data-k="rc_start"]').value.trim() || "1";
      const count = tr.querySelector('[data-k="rc_count"]').value.trim();

      const internalSel = tr.querySelector('[data-k="rc_internal_select"]').value;
      const internalNEl = tr.querySelector('[data-k="rc_internal_n"]');
      showIf(internalNEl, needsN(internalSel));
      const internalN = internalNEl.value.trim();
      const internalAgg = tr.querySelector('[data-k="rc_internal_agg"]').value;

      const finalSel = tr.querySelector('[data-k="rc_final_select"]').value;
      const finalNEl = tr.querySelector('[data-k="rc_final_n"]');
      showIf(finalNEl, needsN(finalSel));
      const finalN = finalNEl.value.trim();
      const finalAgg = tr.querySelector('[data-k="rc_final_agg"]').value;

      // avan√ßat intern
      const internalSelectOn = tr.querySelector('[data-k="rc_internal_select_on"]').value || "raw";
      const internalAggOn    = tr.querySelector('[data-k="rc_internal_agg_on"]').value || "expr";

      const postEnabled = !!tr.querySelector('[data-k="rc_internal_post_enabled"]').checked;
      const postExprEl  = tr.querySelector('[data-k="rc_internal_post_expr"]');
      const postHelpEl  = tr.querySelector('[data-k="rc_internal_post_help"]');

      showIf(postExprEl, postEnabled);
      showIf(postHelpEl, postEnabled);

      const postExpr = (postExprEl?.value || "").trim();

      // avan√ßat final
      const postFinalExpr = (tr.querySelector('[data-k="rc_post_final_expr"]').value || "").trim();

      // construir kwargs (sempre mirem el que NO √©s default)
      const kwargs = [];

      if(start && start !== "1") kwargs.push(`start=${Number(start)}`);
      if(count !== "") kwargs.push(`count=${Number(count)}`);

      // mapping: intern/final ‚Üí row_* / col_* segons preset
      // Row compute:
      //   intern => row_select/row_agg ; final => col_select/col_agg
      // Column compute:
      //   intern => col_select/col_agg ; final => row_select/row_agg
      if (preset === "row_compute"){
        if(internalSel && internalSel !== "all") kwargs.push(`row_select='${internalSel}'`);
        if(needsN(internalSel) && internalN !== "") kwargs.push(`row_select_n=${Number(internalN)}`);
        if(internalAgg && internalAgg !== "sum") kwargs.push(`row_agg='${internalAgg}'`);

        if(finalSel && finalSel !== "all") kwargs.push(`col_select='${finalSel}'`);
        if(needsN(finalSel) && finalN !== "") kwargs.push(`col_select_n=${Number(finalN)}`);
        if(finalAgg && finalAgg !== "sum") kwargs.push(`col_agg='${finalAgg}'`);
      } else {
        if(internalSel && internalSel !== "all") kwargs.push(`col_select='${internalSel}'`);
        if(needsN(internalSel) && internalN !== "") kwargs.push(`col_select_n=${Number(internalN)}`);
        if(internalAgg && internalAgg !== "sum") kwargs.push(`col_agg='${internalAgg}'`);

        if(finalSel && finalSel !== "all") kwargs.push(`row_select='${finalSel}'`);
        if(needsN(finalSel) && finalN !== "") kwargs.push(`row_select_n=${Number(finalN)}`);
        if(finalAgg && finalAgg !== "sum") kwargs.push(`row_agg='${finalAgg}'`);
      }

      // select_on / agg_on / post_agg_expr (apliquen a la FASE INTERNA)
      if(internalAggOn !== "expr") kwargs.push(`agg_on='${internalAggOn}'`);
      if(internalSelectOn !== "expr") kwargs.push(`select_on='${internalSelectOn}'`);

      if(postEnabled && postExpr !== ""){
        const pe = postExpr.replace(/\\/g,"\\\\").replace(/'/g,"\\'");
        kwargs.push(`post_agg_expr='${pe}'`);
      }

      if(postFinalExpr !== ""){
        const pfe = postFinalExpr.replace(/\\/g,"\\\\").replace(/'/g,"\\'");
        kwargs.push(`post_final_expr='${pfe}'`);
      }

      // formula
      const source = sel.value || "";
      const exprEsc = itemExpr.replace(/\\/g,"\\\\").replace(/'/g,"\\'");
      const fnName = (preset === "column_compute") ? "column_custom_compute" : "row_custom_compute";
      const formula = `${fnName}('${source}','${exprEsc}'${kwargs.length ? ", " + kwargs.join(", ") : ""})`;

      tr.querySelector('[data-k="formula"]').value = formula;
      tr.querySelector('[data-k="rc_preview"]').value = formula;
      return;
    }
  }

  function buildSchemaFromUI(){
    const fields = [];
    document.querySelectorAll("#fieldsTable tbody tr").forEach(tr=>{
      const label = tr.querySelector('[data-k="label"]').value.trim();
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();

      const minv = tr.querySelector('[data-k="min"]').value.trim();
      const maxv = tr.querySelector('[data-k="max"]').value.trim();
      const dec  = tr.querySelector('[data-k="decimals"]').value.trim();

      const crashEnabled = !!tr.querySelector('[data-k="crash_enabled"]')?.checked;

      if(!code) return;

      fields.push({
        code,
        label: label || code,
        var: vari || undefined,
        type: "matrix",
        shape: "judge_x_item",
        crash: { enabled: crashEnabled },
        judges: { count: Number(tr.querySelector('[data-k="judges_count"]').value || 1) },
        items:  { count: Number(tr.querySelector('[data-k="items_count"]').value || 1) },
        min: minv!=="" ? Number(minv) : undefined,
        max: maxv!=="" ? Number(maxv) : undefined,
        decimals: dec!=="" ? Number(dec) : undefined
      });
    });

    const computed = [];
    document.querySelectorAll("#computedTable tbody tr").forEach(tr=>{
      const label = tr.querySelector('[data-k="label"]').value.trim();
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();
      const preset = tr.querySelector('[data-k="preset"]').value;
      const formula = tr.querySelector('[data-k="formula"]').value.trim();

      if(!code) return;

      const out = { code, label: label || code, var: vari || undefined, formula };

      // guardar builder per rehidratar presets (format antic/compat)
      if(preset === "row_compute" || preset === "column_compute"){
        const src = tr.querySelector('[data-k="rc_source"]').value;
        const item_expr = tr.querySelector('[data-k="rc_item_expr"]').value.trim() || "x";

        const internalSel = tr.querySelector('[data-k="rc_internal_select"]').value;
        const internalN   = tr.querySelector('[data-k="rc_internal_n"]').value.trim();
        const internalAgg = tr.querySelector('[data-k="rc_internal_agg"]').value;

        const finalSel = tr.querySelector('[data-k="rc_final_select"]').value;
        const finalN   = tr.querySelector('[data-k="rc_final_n"]').value.trim();
        const finalAgg = tr.querySelector('[data-k="rc_final_agg"]').value;

        const start = Number(tr.querySelector('[data-k="rc_start"]').value || 1);
        const count = tr.querySelector('[data-k="rc_count"]').value.trim();

        const internalSelectOn = tr.querySelector('[data-k="rc_internal_select_on"]').value || "raw";
        const internalAggOn    = tr.querySelector('[data-k="rc_internal_agg_on"]').value || "expr";
        const postEnabled      = !!tr.querySelector('[data-k="rc_internal_post_enabled"]').checked;
        const internalPostExpr = (tr.querySelector('[data-k="rc_internal_post_expr"]').value || "").trim();
        const post_final_expr  = (tr.querySelector('[data-k="rc_post_final_expr"]').value || "").trim();

        // map intern/final a row/col segons preset
        const builder = {
          preset: preset,
          source: src,
          item_expr,
          start,
          count: count === "" ? undefined : Number(count),
          post_final_expr: post_final_expr || undefined,
        };

        if (preset === "row_compute"){
          builder.row_select = internalSel;
          builder.row_select_n = internalN === "" ? undefined : Number(internalN);
          builder.row_agg = internalAgg;

          builder.col_select = finalSel;
          builder.col_select_n = finalN === "" ? undefined : Number(finalN);
          builder.col_agg = finalAgg;

          builder.row_select_on = internalSelectOn;
          builder.row_agg_on = internalAggOn;
          builder.row_post_agg_expr = (postEnabled ? (internalPostExpr || undefined) : undefined);

          // camps column_* no calen per row_compute, per√≤ els deixem com abans (no estrictament necessari)
          builder.col_select_on = "expr";
          builder.col_post_agg_expr = undefined;
        } else {
          builder.col_select = internalSel;
          builder.col_select_n = internalN === "" ? undefined : Number(internalN);
          builder.col_agg = internalAgg;

          builder.row_select = finalSel;
          builder.row_select_n = finalN === "" ? undefined : Number(finalN);
          builder.row_agg = finalAgg;

          builder.col_select_on = internalSelectOn;
          // en el teu JS vell, column reutilitzava col_select_on com agg_on:
          // ho mantenim guardant-lo aix√≠, i a l‚Äôhidratar el posem tamb√© a agg_on intern.
          builder.col_post_agg_expr = (postEnabled ? (internalPostExpr || undefined) : undefined);

          builder.row_select_on = "expr";
          builder.row_agg_on = "expr";
          builder.row_post_agg_expr = undefined;
        }

        out.builder = builder;
      }
      else if(preset === "exec_trampoli"){
        const src = tr.querySelector('[data-k="et_source"]').value;
        const crash_code = tr.querySelector('[data-k="et_crash_code"]').value.trim() || src;
        out.builder = { preset: "exec_trampoli", source: src, crash_code };
      }

      computed.push(out);
    });

    const cols = [];
    fields.forEach(f=>cols.push(f.code));
    computed.forEach(c=>cols.push(c.code));

    return { fields, computed, ui: { columns: cols } };
  }

  function refreshAll(){
    // actualitza cada fila computed (aix√≤ tamb√© recalcula la f√≥rmula)
    document.querySelectorAll("#computedTable tbody tr").forEach(tr=>{
      updateComputedRowUI(tr);
    });

    // actualitza JSON avan√ßat
    const adv = qs("#advancedJson");
    if (adv) adv.value = JSON.stringify(buildSchemaFromUI(), null, 2);
  }

  function init(){
    const tbF = document.querySelector("#fieldsTable tbody");
    const tbC = document.querySelector("#computedTable tbody");

    // fields
    (schema.fields || []).forEach(f=>{
      const isNumber = (f.type === "number");
      tbF.appendChild(fieldRow({
        label: f.label,
        code: f.code,
        var: f.var,
        min: f.min,
        max: f.max,
        decimals: f.decimals,
        judges_count: isNumber ? 1 : (f.judges?.count ?? 1),
        items_count: isNumber ? 1 : (f.items?.count ?? 1),
        crash_enabled: isNumber ? false : !!(f.crash?.enabled),
      }));
    });

    // computed
    (schema.computed || []).forEach(c=>{
      tbC.appendChild(computedRow({
        label: c.label,
        code: c.code,
        var: c.var,
        formula: c.formula,
        preset: c.builder?.preset || "manual",
        builder: c.builder || undefined
      }));
    });

    // defaults si est√† buit
    if(!schema.fields || schema.fields.length===0){
      tbF.appendChild(fieldRow({
        label:"Execuci√≥", code:"E", var:"e",
        judges_count: 3, items_count: 11,
        min:0, max:10, decimals:0,
        crash_enabled:true
      }));
      tbF.appendChild(fieldRow({label:"Dificultat", code:"DD", var:"x", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"TOF",        code:"TOF", var:"t", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"HD",         code:"HD",  var:"h", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"Penalitzaci√≥",code:"P",  var:"p", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));

      // E_j (preset trampol√≠)
      tbC.appendChild(computedRow({
        code:"E_j",
        label:"Execuci√≥ per jutge",
        preset:"exec_trampoli",
        builder:{ preset:"exec_trampoli", source:"E", crash_code:"E" },
        formula:""
      }));

      // E_total (row compute)
      tbC.appendChild(computedRow({
        code:"E_total",
        label:"Execuci√≥ total",
        preset:"row_compute",
        builder:{
          preset:"row_compute",
          source:"E",
          item_expr:"1 - x",
          row_select:"all",
          row_agg:"sum",
          col_select:"drop_extremes",
          col_agg:"sum",
          start:1
        },
        formula:""
      }));

      tbC.appendChild(computedRow({
        code:"TOTAL",
        label:"Total",
        preset:"manual",
        formula:"E_total + x + t + h - p"
      }));
    }

    document.getElementById("btnAddField").addEventListener("click", ()=>{
      tbF.appendChild(fieldRow({label:"", code:"", var:"", judges_count:1, items_count:1}));
      refreshAll();
    });

    document.getElementById("btnAddComputed").addEventListener("click", ()=>{
      tbC.appendChild(computedRow({code:"", var:"", preset:"manual", formula:""}));
      refreshAll();
    });

    document.getElementById("schemaForm").addEventListener("submit", ()=>{
      const built = buildSchemaFromUI();
      const hidden = document.querySelector('[name="schema_json"]');
      if (hidden) hidden.value = JSON.stringify(built);
      const adv = qs("#advancedJson");
      if (adv) adv.value = JSON.stringify(built, null, 2);
    });

    refreshAll();
  }

  init();
</script>
{% endblock %}
