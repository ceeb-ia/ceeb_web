{% extends "base.html" %}
{% block title %}Puntuació – {{ aparell.nom }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .pill-help{ font-size:.85rem; color:#6c757d; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .table td, .table th{ vertical-align:middle; }
    .w-120{ width:120px; }
    .w-140{ width:140px; }
    .w-160{ width:160px; }
    .w-200{ width:200px; }
    .badge-soft{ background:#f1f3f5; border:1px solid #e9ecef; }
    .d-none{ display:none !important; }
  </style>

  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-1">Puntuació · {{ aparell.nom }}</h2>
      {% if competicio %}
        <div class="text-muted small">Competició: <strong>{{ competicio.nom }}</strong></div>
      {% endif %}
      <div class="text-muted small">Configura camps i fórmules sense escriure JSON.</div>
      </div>
    </div>

    <form method="post" id="schemaForm">
      {% csrf_token %}

      {% if form.errors %}
        <pre class="alert alert-warning" style="white-space: pre-wrap;">{{ form.errors }}</pre>
      {% endif %}

      {{ form.schema_json }}

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" data-toggle="tab" href="#tab-fields" role="tab">Camps</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#tab-formules" role="tab">Fórmules</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#tab-advanced" role="tab">Avançat (JSON)</a>
        </li>
      </ul>

      <div class="tab-content pt-3">
        <!-- CAMPS -->
        <div class="tab-pane fade show active" id="tab-fields" role="tabpanel">
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="font-weight-bold">Camps d’entrada</div>
                <div class="pill-help">
                  Defineix què omplirà el jurat. Els criteris d’agregació/selecció ara es defineixen a <strong>Fórmules</strong>.
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddField">Afegir camp</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-bordered" id="fieldsTable">
                <thead class="thead-light">
                  <tr>
                    <th>Etiqueta</th>
                    <th class="w-120">Code</th>
                    <th class="w-120">Var</th>

                    <th class="w-120">Jutges</th>
                    <th class="w-120">Ítems</th>

                    <th class="w-120">Min</th>
                    <th class="w-120">Max</th>
                    <th class="w-120">Decimals</th>

                    <th class="w-120">Crash</th>
                    <th class="w-120"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- FÒRMULES -->
        <div class="tab-pane fade" id="tab-formules" role="tabpanel">
          <div class="border rounded p-3">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div class="font-weight-bold">Fórmules (camps calculats)</div>
                <div class="pill-help">
                  Tria una <strong>funció</strong> (preset) o “Funció manual”.
                  Les fórmules s’avaluen <strong>de dalt a baix</strong>.
                </div>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddComputed">Afegir fórmula</button>
            </div>

            <div class="alert alert-light border mb-2">
              <div class="small">
                <div class="font-weight-bold mb-1">Ajuda</div>
                <ul class="mb-0 pl-3">
                  <li>Els xips de sota insereixen <span class="mono">CODE</span> o <span class="mono">var</span> a la fórmula manual.</li>
                  <li><strong>Row/Col compute</strong>: només escrius el càlcul per ítem (<span class="mono">x</span> i <span class="mono">i</span>) i selecciones criteris amb desplegables.</li>
                  <li>Funcions manuals disponibles: <span class="mono">sum</span>, <span class="mono">avg</span>, <span class="mono">min</span>, <span class="mono">max</span>, <span class="mono">med</span>, <span class="mono">best_n</span>, <span class="mono">row_custom_compute</span>, <span class="mono">exec_by_judge</span>, <span class="mono">select_sum</span>.</li>
                </ul>
              </div>
            </div>

            <div class="mb-2">
              <div class="pill-help mb-1">
                <strong>Inserir camps / àlies</strong>
                <span class="text-muted">· CODE = nom del camp · var: = àlies curt</span>
              </div>
              <div id="varsChips" class="d-flex flex-wrap" style="gap:6px;"></div>
              <div class="pill-help mt-1">Consell: fes clic sobre un xip per inserir-lo dins la cel·la de “Fórmula manual”.</div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-bordered" id="computedTable">
                <thead class="thead-light">
                  <tr>
                    <th>Etiqueta</th>
                    <th class="w-140">Code</th>
                    <th class="w-120">Var</th>
                    <th class="w-200">Funció</th>
                    <th>Configuració / Fórmula</th>
                    <th class="w-120"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>

        <!-- AVANÇAT JSON -->
        <div class="tab-pane fade" id="tab-advanced" role="tabpanel">
          <div class="border rounded p-3">
            <div class="font-weight-bold mb-2">Avançat (JSON)</div>
            <div class="pill-help mb-2">JSON generat automàticament pel builder (només lectura).</div>
            <textarea id="advancedJson" class="form-control mono" rows="18" readonly></textarea>
          </div>
        </div>
      </div>

      <div class=" gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Desar</button>
        <a class="btn btn-outline-secondary" href="{{ next|default:request.META.HTTP_REFERER }}">Cancel·lar</a>
      </div>
    </form>
  </div>
</div>

{{ schema_initial|json_script:"schema-initial" }}

<script>
  // --- Schema inicial ---
  let schema = {};
  try { schema = JSON.parse(document.getElementById("schema-initial").textContent || "{}"); }
  catch (e) { schema = {}; }

  // --- Helpers ---
  function uid(){ return Math.random().toString(16).slice(2); }
  function qs(sel){ return document.querySelector(sel); }

  // --- Select options ---
  const PRESET_FUNCS = [
    ["manual", "Funció manual (escriure fórmula)"],
    ["row_compute", "Row/Col compute (guiada)"],
    ["exec_trampoli", "Execució trampolí (E_j) (guiada)"],
  ];

  const ROW_SELECT_OPTIONS = [
    ["all", "Tots"],
    ["drop_extremes", "Eliminar extrems (min i max)"],
    ["best_n", "Millors N"],
    ["worst_n", "Pitjors N"],
  ];

  const AGG_OPTIONS = [
    ["sum", "Suma"],
    ["avg", "Mitjana"],
    ["med", "Mediana"],
    ["min", "Mínim"],
    ["max", "Màxim"],
  ];

  function optionHTML(opts){
    return opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join("");
  }

  function allCodes(){
    const codes = [];
    document.querySelectorAll("#fieldsTable tbody tr").forEach(r=>{
      const c = r.querySelector('[data-k="code"]').value.trim();
      if(c) codes.push(c);
    });
    document.querySelectorAll("#computedTable tbody tr").forEach(r=>{
      const c = r.querySelector('[data-k="code"]').value.trim();
      if(c) codes.push(c);
    });
    return Array.from(new Set(codes));
  }

  // --- Fields row (sense criteris) ---
  function fieldRow(data){
    const tr = document.createElement("tr");
    tr.dataset.id = uid();
    tr.innerHTML = `
      <td><input class="form-control form-control-sm" data-k="label" value="${data.label||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="code" value="${data.code||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="var" value="${data.var||""}"></td>

      <td><input class="form-control form-control-sm" data-k="judges_count" value="${data.judges_count ?? ""}" placeholder="ex: 3"></td>
      <td><input class="form-control form-control-sm" data-k="items_count" value="${data.items_count ?? ""}" placeholder="ex: 11"></td>

      <td><input class="form-control form-control-sm" data-k="min" value="${data.min ?? ""}"></td>
      <td><input class="form-control form-control-sm" data-k="max" value="${data.max ?? ""}"></td>
      <td><input class="form-control form-control-sm" data-k="decimals" value="${data.decimals ?? ""}"></td>

      <td class="text-center">
        <input type="checkbox" data-k="crash_enabled">
      </td>

      <td class="text-center">
        <button type="button" class="btn btn-sm btn-outline-danger">Eliminar</button>
      </td>
    `;

    tr.querySelector('input[data-k="crash_enabled"]').checked = !!data.crash_enabled;

    tr.querySelector("button").addEventListener("click", ()=>{
      tr.remove();
      refreshVars();
    });

    tr.querySelectorAll("input,select").forEach(i=>{
      i.addEventListener("input", refreshVars);
      i.addEventListener("change", refreshVars);
    });

    return tr;
  }

  // --- Computed row (preset dropdown + conditional UI) ---
  function computedRow(data){
    const tr = document.createElement("tr");
    tr.dataset.id = uid();

    const preset = data.preset || data.builder?.preset || "manual";

    tr.innerHTML = `
      <td><input class="form-control form-control-sm" data-k="label" value="${data.label||""}" placeholder="Etiqueta"></td>
      <td><input class="form-control form-control-sm mono" data-k="code" value="${data.code||""}"></td>
      <td><input class="form-control form-control-sm mono" data-k="var" value="${data.var||""}"></td>

      <td>
        <select class="form-control form-control-sm" data-k="preset">
          ${optionHTML(PRESET_FUNCS)}
        </select>
        <div class="pill-help mt-1">
          <span class="badge badge-soft">Preset</span> genera la fórmula.
        </div>
      </td>

      <td>
        <!-- MANUAL -->
        <div data-box="manual">
          <input class="form-control form-control-sm mono" data-k="manual_formula" value="${data.formula||""}" placeholder="Ex: TOTAL = E_total + x - p">
          <div class="pill-help mt-1">
            Escriu una expressió. Pots usar <span class="mono">CODE</span> i <span class="mono">var</span>.
          </div>
        </div>

        <!-- ROW_COMPUTE -->
        <div data-box="row_compute" class="border rounded p-2 d-none">
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Camp font (matriu)</label>
              <select class="form-control form-control-sm mono" data-k="rc_source"></select>
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Càlcul per ítem</label>
              <input class="form-control form-control-sm mono" data-k="rc_item_expr" placeholder="Ex: 1 - x">
              <div class="pill-help mt-1">Usa <span class="mono">x</span>=valor, <span class="mono">i</span>=índex (1..N)</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Selecció ítems (fila)</label>
              <select class="form-control form-control-sm" data-k="rc_row_select">${optionHTML(ROW_SELECT_OPTIONS)}</select>
              <input class="form-control form-control-sm mt-1 d-none" data-k="rc_row_n" placeholder="N (si aplica)">
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Agregació fila</label>
              <select class="form-control form-control-sm" data-k="rc_row_agg">${optionHTML(AGG_OPTIONS)}</select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Selecció jutges</label>
              <select class="form-control form-control-sm" data-k="rc_col_select">${optionHTML(ROW_SELECT_OPTIONS)}</select>
              <input class="form-control form-control-sm mt-1 d-none" data-k="rc_col_n" placeholder="N (si aplica)">
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Agregació final</label>
              <select class="form-control form-control-sm" data-k="rc_col_agg">${optionHTML(AGG_OPTIONS)}</select>
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Rang d’ítems</label>
              <div class="d-flex" style="gap:6px;">
                <input class="form-control form-control-sm" data-k="rc_start" placeholder="start" value="1">
                <input class="form-control form-control-sm" data-k="rc_count" placeholder="count (opcional)">
              </div>
              <div class="pill-help mt-1">Per defecte: tots els ítems (respecta crash del camp)</div>
            </div>

            <div class="col-md-3 mb-2">
              <label class="small text-muted mb-1">Preview fórmula</label>
              <input class="form-control form-control-sm mono" data-k="rc_preview" readonly>
            </div>
          </div>
        </div>

        <!-- EXEC_TRAMPOLI (E_j) -->
        <div data-box="exec_trampoli" class="border rounded p-2 d-none">
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Camp Execució (matriu)</label>
              <select class="form-control form-control-sm mono" data-k="et_source"></select>
              <div class="pill-help mt-1">Genera una llista “per jutge”.</div>
            </div>
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Crash del camp</label>
              <input class="form-control form-control-sm mono" data-k="et_crash_code" placeholder="Ex: E" value="">
              <div class="pill-help mt-1">Normalment és el mateix codi (Ex: <span class="mono">E</span>).</div>
            </div>
            <div class="col-md-4 mb-2">
              <label class="small text-muted mb-1">Preview fórmula</label>
              <input class="form-control form-control-sm mono" data-k="et_preview" readonly>
            </div>
          </div>
        </div>

        <!-- Fórmula real que es guarda -->
        <input type="hidden" data-k="formula" value="${data.formula||""}">
      </td>

      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger">Eliminar</button></td>
    `;

    // preset init
    tr.querySelector('select[data-k="preset"]').value = preset;

    // delete
    tr.querySelector("button").addEventListener("click", ()=>{
      tr.remove();
      refreshVars();
    });

    // hydrate builder
    const b = data.builder || {};
    if (preset === "row_compute") {
      tr.querySelector('[data-k="rc_item_expr"]').value = b.item_expr || "";
      tr.querySelector('[data-k="rc_row_select"]').value = b.row_select || "all";
      tr.querySelector('[data-k="rc_row_agg"]').value = b.row_agg || "sum";
      tr.querySelector('[data-k="rc_col_select"]').value = b.col_select || "all";
      tr.querySelector('[data-k="rc_col_agg"]').value = b.col_agg || "sum";
      tr.querySelector('[data-k="rc_start"]').value = (b.start ?? 1) + "";
      tr.querySelector('[data-k="rc_count"]').value = (b.count ?? "") + "";
      if (b.row_select_n != null) tr.querySelector('[data-k="rc_row_n"]').value = b.row_select_n;
      if (b.col_select_n != null) tr.querySelector('[data-k="rc_col_n"]').value = b.col_select_n;
    }
    if (preset === "exec_trampoli") {
      tr.querySelector('[data-k="et_crash_code"]').value = (b.crash_code || "") + "";
    }

    // events
    tr.querySelectorAll("input,select").forEach(i=>{
      i.addEventListener("input", refreshVars);
      i.addEventListener("change", refreshVars);
    });

    return tr;
  }

  function showIf(el, yes){
    if(!el) return;
    el.classList.toggle("d-none", !yes);
  }

  function needsN(method){
    return (method === "best_n" || method === "worst_n");
  }

  function updateComputedRowUI(tr){
    const preset = tr.querySelector('[data-k="preset"]').value;

    const boxManual = tr.querySelector('[data-box="manual"]');
    const boxRC     = tr.querySelector('[data-box="row_compute"]');
    const boxET     = tr.querySelector('[data-box="exec_trampoli"]');

    showIf(boxManual, preset === "manual");
    showIf(boxRC,     preset === "row_compute");
    showIf(boxET,     preset === "exec_trampoli");

    // reomplir sources
    const codes = allCodes();

    // MANUAL
    if(preset === "manual"){
      const mf = tr.querySelector('[data-k="manual_formula"]').value.trim();
      tr.querySelector('[data-k="formula"]').value = mf;
      return;
    }

    // ROW_COMPUTE
    if(preset === "row_compute"){
      const sel = tr.querySelector('[data-k="rc_source"]');
      const current = sel.value || "";
      sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join("");
      sel.value = (codes.includes(current) ? current : (codes[0] || ""));

      const itemExpr = (tr.querySelector('[data-k="rc_item_expr"]').value.trim() || "x");

      const rowSel = tr.querySelector('[data-k="rc_row_select"]').value;
      const rowNEl = tr.querySelector('[data-k="rc_row_n"]');
      showIf(rowNEl, needsN(rowSel));
      const rowN = rowNEl.value.trim();

      const rowAgg = tr.querySelector('[data-k="rc_row_agg"]').value;

      const colSel = tr.querySelector('[data-k="rc_col_select"]').value;
      const colNEl = tr.querySelector('[data-k="rc_col_n"]');
      showIf(colNEl, needsN(colSel));
      const colN = colNEl.value.trim();

      const colAgg = tr.querySelector('[data-k="rc_col_agg"]').value;

      const start = tr.querySelector('[data-k="rc_start"]').value.trim() || "1";
      const count = tr.querySelector('[data-k="rc_count"]').value.trim();

      const kwargs = [];
      if(start && start !== "1") kwargs.push(`start=${Number(start)}`);
      if(count !== "") kwargs.push(`count=${Number(count)}`);

      if(rowSel && rowSel !== "all") kwargs.push(`row_select='${rowSel}'`);
      if(needsN(rowSel) && rowN !== "") kwargs.push(`row_select_n=${Number(rowN)}`);
      if(rowAgg && rowAgg !== "sum") kwargs.push(`row_agg='${rowAgg}'`);

      if(colSel && colSel !== "all") kwargs.push(`col_select='${colSel}'`);
      if(needsN(colSel) && colN !== "") kwargs.push(`col_select_n=${Number(colN)}`);
      if(colAgg && colAgg !== "sum") kwargs.push(`col_agg='${colAgg}'`);

      const source = sel.value || "";
      const exprEsc = itemExpr.replace(/\\/g,"\\\\").replace(/'/g,"\\'");
      const formula = `row_custom_compute('${source}','${exprEsc}'${kwargs.length ? ", " + kwargs.join(", ") : ""})`;

      tr.querySelector('[data-k="formula"]').value = formula;
      tr.querySelector('[data-k="rc_preview"]').value = formula;
      return;
    }

    // EXEC_TRAMPOLI
    if(preset === "exec_trampoli"){
      const sel = tr.querySelector('[data-k="et_source"]');
      const current = sel.value || "";
      sel.innerHTML = codes.map(c=>`<option value="${c}">${c}</option>`).join("");
      sel.value = (codes.includes(current) ? current : (codes[0] || ""));

      const src = sel.value || "";
      const crashCode = (tr.querySelector('[data-k="et_crash_code"]').value.trim() || src);

      const formula = `exec_by_judge(${src}, crash('${crashCode}'), params)`;
      tr.querySelector('[data-k="formula"]').value = formula;
      tr.querySelector('[data-k="et_preview"]').value = formula;
      return;
    }
  }

  // --- Chips + vars ---
  function refreshVars(){
    // primer, actualitza UI de presets (això pot canviar codes disponibles)
    document.querySelectorAll("#computedTable tbody tr").forEach(tr=>{
      updateComputedRowUI(tr);
    });

    const tokens = []; // {type:'code'|'var', value:'...'}
    document.querySelectorAll("#fieldsTable tbody tr").forEach(tr=>{
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();
      if (code) tokens.push({type:"code", value:code});
      if (vari) tokens.push({type:"var",  value:vari});
    });
    document.querySelectorAll("#computedTable tbody tr").forEach(tr=>{
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();
      if (code) tokens.push({type:"code", value:code});
      if (vari) tokens.push({type:"var",  value:vari});
    });

    const seen = new Set();
    const unique = [];
    for (const t of tokens){
      const k = `${t.type}:${t.value}`;
      if (!t.value) continue;
      if (seen.has(k)) continue;
      seen.add(k);
      unique.push(t);
    }
    unique.sort((a,b)=>{
      if (a.type !== b.type) return a.type === "code" ? -1 : 1;
      return a.value.localeCompare(b.value);
    });

    const wrap = document.getElementById("varsChips");
    wrap.innerHTML = "";

    unique.forEach(t=>{
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn btn-sm btn-outline-secondary mono";
      const label = (t.type === "var") ? `var:${t.value}` : t.value;
      b.textContent = label;

      b.title = (t.type === "var")
        ? "Àlies curt (var). Inserirà l’àlies a la fórmula."
        : "Codi del camp/resultat. Inserirà el CODE a la fórmula.";

      b.addEventListener("click", ()=>{
        const active = document.activeElement;
        if(active && active.matches('#computedTable input[data-k="manual_formula"]')){
          const insertValue = t.value;
          const start = active.selectionStart || active.value.length;
          const end = active.selectionEnd || active.value.length;
          active.value = active.value.slice(0,start) + insertValue + active.value.slice(end);
          active.focus();
          active.selectionStart = active.selectionEnd = start + insertValue.length;
          refreshVars();
        }
      });

      wrap.appendChild(b);
    });

    const adv = qs("#advancedJson");
    if (adv) adv.value = JSON.stringify(buildSchemaFromUI(), null, 2);
  }

  function buildSchemaFromUI(){
    const fields = [];
    document.querySelectorAll("#fieldsTable tbody tr").forEach(tr=>{
      const label = tr.querySelector('[data-k="label"]').value.trim();
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();

      const minv = tr.querySelector('[data-k="min"]').value.trim();
      const maxv = tr.querySelector('[data-k="max"]').value.trim();
      const dec  = tr.querySelector('[data-k="decimals"]').value.trim();

      const crashEnabled = !!tr.querySelector('[data-k="crash_enabled"]')?.checked;

      if(!code) return;

      fields.push({
        code,
        label: label || code,
        var: vari || undefined,
        type: "matrix",
        shape: "judge_x_item",
        crash: { enabled: crashEnabled },
        judges: { count: Number(tr.querySelector('[data-k="judges_count"]').value || 1) },
        items:  { count: Number(tr.querySelector('[data-k="items_count"]').value || 1) },
        min: minv!=="" ? Number(minv) : undefined,
        max: maxv!=="" ? Number(maxv) : undefined,
        decimals: dec!=="" ? Number(dec) : undefined
      });
    });

    const computed = [];
    document.querySelectorAll("#computedTable tbody tr").forEach(tr=>{
      const label = tr.querySelector('[data-k="label"]').value.trim();
      const code = tr.querySelector('[data-k="code"]').value.trim();
      const vari = tr.querySelector('[data-k="var"]').value.trim();
      const preset = tr.querySelector('[data-k="preset"]').value;
      const formula = tr.querySelector('[data-k="formula"]').value.trim();

      if(!code) return;

      const out = { code, label: label || code, var: vari || undefined, formula };

      // guarda builder per rehidratar presets
      if(preset === "row_compute"){
        const src = tr.querySelector('[data-k="rc_source"]').value;
        const item_expr = tr.querySelector('[data-k="rc_item_expr"]').value.trim() || "x";
        const row_select = tr.querySelector('[data-k="rc_row_select"]').value;
        const row_select_n = tr.querySelector('[data-k="rc_row_n"]').value.trim();
        const row_agg = tr.querySelector('[data-k="rc_row_agg"]').value;

        const col_select = tr.querySelector('[data-k="rc_col_select"]').value;
        const col_select_n = tr.querySelector('[data-k="rc_col_n"]').value.trim();
        const col_agg = tr.querySelector('[data-k="rc_col_agg"]').value;

        const start = Number(tr.querySelector('[data-k="rc_start"]').value || 1);
        const count = tr.querySelector('[data-k="rc_count"]').value.trim();

        out.builder = {
          preset: "row_compute",
          source: src,
          item_expr,
          row_select,
          row_select_n: row_select_n === "" ? undefined : Number(row_select_n),
          row_agg,
          col_select,
          col_select_n: col_select_n === "" ? undefined : Number(col_select_n),
          col_agg,
          start,
          count: count === "" ? undefined : Number(count),
        };
      }
      else if(preset === "exec_trampoli"){
        const src = tr.querySelector('[data-k="et_source"]').value;
        const crash_code = tr.querySelector('[data-k="et_crash_code"]').value.trim() || src;
        out.builder = {
          preset: "exec_trampoli",
          source: src,
          crash_code
        };
      }
      else {
        // manual: no cal builder
      }

      computed.push(out);
    });

    const cols = [];
    fields.forEach(f=>cols.push(f.code));
    computed.forEach(c=>cols.push(c.code));

    return { fields, computed, ui: { columns: cols } };
  }

  function init(){
    const tbF = document.querySelector("#fieldsTable tbody");
    const tbC = document.querySelector("#computedTable tbody");

    // fields
    (schema.fields || []).forEach(f=>{
      const isNumber = (f.type === "number");
      tbF.appendChild(fieldRow({
        label: f.label,
        code: f.code,
        var: f.var,
        min: f.min,
        max: f.max,
        decimals: f.decimals,
        judges_count: isNumber ? 1 : (f.judges?.count ?? 1),
        items_count: isNumber ? 1 : (f.items?.count ?? 1),
        crash_enabled: isNumber ? false : !!(f.crash?.enabled),
      }));
    });

    // computed
    (schema.computed || []).forEach(c=>{
      tbC.appendChild(computedRow({
        label: c.label,
        code: c.code,
        var: c.var,
        formula: c.formula,
        preset: c.builder?.preset || "manual",
        builder: c.builder || undefined
      }));
    });

    // defaults
    if(!schema.fields || schema.fields.length===0){
      tbF.appendChild(fieldRow({
        label:"Execució", code:"E", var:"e",
        judges_count: 3, items_count: 11,
        min:0, max:10, decimals:0,
        crash_enabled:true
      }));
      tbF.appendChild(fieldRow({label:"Dificultat", code:"DD", var:"x", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"TOF",        code:"TOF", var:"t", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"HD",         code:"HD",  var:"h", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));
      tbF.appendChild(fieldRow({label:"Penalització",code:"P",  var:"p", judges_count:1, items_count:1, decimals:3, crash_enabled:false}));

      // E_j (preset trampolí)
      tbC.appendChild(computedRow({
        code:"E_j",
        label:"Execució per jutge",
        preset:"exec_trampoli",
        builder:{ preset:"exec_trampoli", source:"E", crash_code:"E" },
        formula:""
      }));

      // E_total (preset row_compute: selecció jutges i suma)
      tbC.appendChild(computedRow({
        code:"E_total",
        label:"Execució total",
        preset:"row_compute",
        builder:{
          preset:"row_compute",
          source:"E",               // IMPORTANT: matriu original (respecta crash)
          item_expr:"1 - x",        // exemple: converteix deducció -> punts
          row_select:"all",
          row_agg:"sum",            // suma per jutge fins al crash
          col_select:"drop_extremes",
          col_agg:"sum",
          start:1
        },
        formula:""
      }));

      tbC.appendChild(computedRow({
        code:"TOTAL",
        label:"Total",
        preset:"manual",
        formula:"E_total + x + t + h - p"
      }));
    }

    document.getElementById("btnAddField").addEventListener("click", ()=>{
      tbF.appendChild(fieldRow({label:"", code:"", var:"", judges_count:1, items_count:1}));
      refreshVars();
    });

    document.getElementById("btnAddComputed").addEventListener("click", ()=>{
      tbC.appendChild(computedRow({code:"", var:"", preset:"manual", formula:""}));
      refreshVars();
    });

    document.getElementById("schemaForm").addEventListener("submit", ()=>{
      const built = buildSchemaFromUI();
      const hidden = document.querySelector('[name="schema_json"]');
      if (hidden) hidden.value = JSON.stringify(built);
      const adv = qs("#advancedJson");
      if (adv) adv.value = JSON.stringify(built, null, 2);
    });

    refreshVars();
  }

  init();
</script>
{% endblock %}
