{% extends "base.html" %}
{% load static %}
{% load competicio_extras %}

{% block title %}Inscripcions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .grouping-controls {
      background: #f7f8fb;
      border: 1px solid #e3e6ef;
      border-radius: 12px;
      padding: 12px 14px;
    }
    .grouping-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 10px;
      align-items: center;
    }
    .group-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid #cfd6e6;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.03);
      cursor: pointer;
      user-select: none;
    }
    .group-chip input { margin: 0; }
    .grouping-actions { display: flex; gap: 8px; align-items: center; }

    /* Files d’agrupació (si les uses fora de pestanyes) */
    tr.group-row { background-color: #f2f4f7; border-top: 2px solid #cbd5e1; }
    tr.group-row td { padding: 10px 12px; font-weight: 600; color: #1f2937; }
    tr.group-categoria { background-color: #e0f2fe; }
    tr.group-subcategoria { background-color: #ecfeff; }

    tr.group-row > td {
      background-color: #e0f2fe !important;
      border-top: 2px solid #94a3b8;
      border-bottom: 1px solid #cbd5e1;
      font-weight: 600;
    }
    tr.group-g1 > td { background-color: #dbeafe !important; }
    tr.group-g2 > td { background-color: #e0f2fe !important; }
    tr.group-g3 > td { background-color: #ecfeff !important; }

    .hidden-header { display: none; }

    tr.hidden-placeholder > td {
      padding: 0 !important;
      background: transparent !important;
      border-top: none !important;
      border-bottom: none !important;
      height: 22px !important;
      line-height: 22px !important;
      vertical-align: middle !important;
    }

    .hidden-tab {
      display: inline-block;
      padding: 0 6px;
      height: 18px;
      line-height: 18px;
      border-radius: 6px;
      background: #fff8f0;
      border: 1px solid #f4d3b0;
      color: #7c2d12;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: none;
    }

    .btn-tiny {
      font-size: 0.65rem;
      padding: 0.18rem 0.4rem;
      line-height: 1;
      border-radius: 6px;
    }

    /* Un petit “cursor” perquè es noti que es pot arrossegar */
    .nav-tabs .nav-item { cursor: grab; }
    .inscripcio-row { cursor: grab; }
  </style>

  <div class="card-surface">
    <!-- CAPÇALERA -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Inscripcions</h2>
        <div class="text-muted small">
          Competició: <span class="font-weight-bold">{{ competicio.nom }}</span>
        </div>
      </div>

      <div class="d-flex align-items-center" style="gap: 8px;">
        <a href="{% url 'import' competicio.id %}" class="btn btn-success">+ Importar Excel</a>
        <a href="{% url 'inscripcio_add' competicio.id %}?next={{ request.get_full_path|urlencode }}" class="btn btn-primary">+ Afegir inscripció</a>
        <a href="{% url 'trampoli_config' competicio.id %}" class="btn btn-outline-secondary">Configuració competició</a>
        <a href="{% url 'created' %}" class="btn btn-info">Tornar a competicions</a>
      </div>
    </div>

    <!-- FILTRES + AGRUPACIÓ -->
    <form method="get" class="mb-3">
      <input type="hidden" name="q" value="{{ request.GET.q|default:'' }}">
      <input type="hidden" name="categoria" value="{{ request.GET.categoria|default:'' }}">
      <input type="hidden" name="subcategoria" value="{{ request.GET.subcategoria|default:'' }}">
      <input type="hidden" name="entitat" value="{{ request.GET.entitat|default:'' }}">
      <input type="hidden" name="per_page" value="{{ request.GET.per_page|default:'10' }}">

      <div class="grouping-controls grouping-chips">
        <span class="font-weight-bold small text-muted">Agrupa per:</span>

        {% for f in allowed_group_fields %}
          <label class="group-chip small mb-0">
            <input type="checkbox"
                   name="group_by"
                   value="{{ f }}"
                   {% if f in selected_group_fields %}checked{% endif %}>
            {{ f|capfirst }}
          </label>
        {% endfor %}

        <div class="grouping-actions">
          <button type="submit" name="recalc_order" value="1" class="btn btn-sm btn-outline-primary">
            Aplicar agrupació
          </button>

          <button type="submit" name="shuffle_order" value="1" class="btn btn-sm btn-outline-warning">
            Barreja aleatòriament
          </button>

          {% if selected_group_fields %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?clear_group=1&q={{ request.GET.q|urlencode }}&categoria={{ request.GET.categoria|urlencode }}&subcategoria={{ request.GET.subcategoria|urlencode }}&entitat={{ request.GET.entitat|urlencode }}">
              Treure agrupació
            </a>
          {% endif %}
        </div>

        <button class="btn btn-sm btn-outline-warning"
                name="undo"
                value="1"
                {% if not request.session.inscripcions_undo_state %}disabled{% endif %}>
          Tirar enrere
        </button>

        <span>Grups:</span>
        <select name="group_mode" class="form-control form-control-sm" style="width:170px">
          {% with gm=request.GET.group_mode|default:"fixed" %}
            <option value="fixed" {% if gm == "fixed" %}selected{% endif %}>Mida fixa</option>
            <option value="balanced" {% if gm == "balanced" %}selected{% endif %}>Grups equilibrats</option>
          {% endwith %}
        </select>

        Mida dels grups:
        <input type="number" name="group_size" min="2" max="50"
               value="{{ request.GET.group_size|default:8 }}"
               class="form-control form-control-sm" style="width:90px"
               placeholder="Mida">

        <button type="submit" name="make_groups" value="1" class="btn btn-sm btn-outline-dark">
          Crear grups
        </button>

        <div class="d-flex align-items-center flex-wrap" style="gap: 8px;">
          <select name="sort_key" class="form-control form-control-sm" style="width: 210px;">
            {% with sk=request.GET.sort_key|default:"nom" %}
              <option value="nom" {% if sk == "nom" %}selected{% endif %}>Nom (A-Z)</option>
              <option value="edat" {% if sk == "edat" %}selected{% endif %}>Edat / Data naixement</option>
              <option value="entitat" {% if sk == "entitat" %}selected{% endif %}>Entitat</option>
              <option value="categoria" {% if sk == "categoria" %}selected{% endif %}>Categoria</option>
              <option value="subcategoria" {% if sk == "subcategoria" %}selected{% endif %}>Subcategoria</option>
              <option value="sexe" {% if sk == "sexe" %}selected{% endif %}>Sexe</option>
              <option value="document" {% if sk == "document" %}selected{% endif %}>Document</option>
            {% endwith %}
          </select>

          <select name="sort_dir" class="form-control form-control-sm" style="width: 110px;">
            {% with sd=request.GET.sort_dir|default:"asc" %}
              <option value="asc" {% if sd == "asc" %}selected{% endif %}>Asc</option>
              <option value="desc" {% if sd == "desc" %}selected{% endif %}>Desc</option>
              <option value="arrow_asc" {% if sd == "arrow_asc" %}selected{% endif %}>Fletxa (asc)</option>
              <option value="arrow_desc" {% if sd == "arrow_desc" %}selected{% endif %}>Fletxa (desc)</option>
            {% endwith %}
          </select>

          <button class="btn btn-sm btn-outline-secondary" name="sort_within_groups" value="1">
            Ordena dins grups
          </button>
        </div>

        <button type="submit" name="clear_groups" value="1" class="btn btn-sm btn-outline-secondary">
          Esborrar grups
        </button>
      </div>

      <div class="d-flex align-items-center flex-wrap mt-2" style="gap: 10px;">
        <div class="small text-muted">Títol de grup:</div>

        {% for key in allowed_group_fields %}
          <label class="form-check form-check-inline m-0">
            <input class="form-check-input"
                   type="checkbox"
                   name="title_fields"
                   value="{{ key }}"
                   {% if key in title_fields_selected %}checked{% endif %}>
            <span class="form-check-label">{{ key|capfirst }}</span>
          </label>
        {% endfor %}

        <button class="btn btn-sm btn-outline-success" name="export_excel" value="1">
          Exportar Excel
        </button>
      </div>
    </form>

    <!-- TAULA AMB PESTANYES -->
    {% if records_grouped %}
      <ul class="nav nav-tabs mt-3 js-sortable-tabs" role="tablist" id="tabs-root">
        {% for group, group_records in records_grouped %}
          <li class="nav-item"role="presentation" data-pane-id="pane-{{ forloop.counter0 }}" data-group-key="{{ group|default:'(Sense valor)' }}">

            <a class="nav-link {% if forloop.first %}active{% endif %}"
               id="tab-{{ forloop.counter0 }}"
               data-toggle="tab"
               href="#pane-{{ forloop.counter0 }}"
               role="tab"
               aria-controls="pane-{{ forloop.counter0 }}"
               aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
              {{ group|default:"(Sense valor)" }}
              <span class="badge badge-light ml-1">{{ group_records|length }}</span>
            </a>
          </li>
        {% endfor %}
      </ul>

      <div class="tab-content pt-3" id="tabs-content">
        {% for group, group_records in records_grouped %}
          <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
               id="pane-{{ forloop.counter0 }}"
               role="tabpanel"
               aria-labelledby="tab-{{ forloop.counter0 }}">
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Nom i cognoms</th>
                    <th>DNI</th>
                    <th>Sexe</th>
                    <th>Data naixement</th>
                    <th>Entitat</th>
                    <th>Categoria</th>
                    <th>Subcategoria</th>
                    <th>Grup</th>
                    <th>Ordre</th>
                    <th>Accions</th>
                  </tr>
                </thead>

                <!-- IMPORTANT: class sortable-body -->
                {% with g1=selected_group_fields.0 g2=selected_group_fields.1 g3=selected_group_fields.2 %}
                <tbody class="sortable-body" data-pane-id="pane-{{ forloop.counter0 }}">
                  {% for r in group_records %}

                    {# HEADER g2 (subagrupació) #}
                    {% if g2 %}
                      {% ifchanged r|attr:g2 %}
                        <tr class="group-row group-g2"
                            id="header-g2-{{ forloop.parentloop.counter0 }}-{{ forloop.counter }}"
                            data-label="{{ r|attr_default:g2|default:'(Sense valor)' }}">
                          <td colspan="10">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="d-flex align-items-center" style="gap:10px;">
                                <span class="font-weight-bold">{{ g2|capfirst }}:</span>
                                <span>{{ r|attr_default:g2|default:"(Sense valor)" }}</span>

                                <button type="button"
                                        class="btn btn-sm btn-outline-dark js-independent-group"
                                        data-lvl="g2"
                                        data-v1="{{ group|default:'__NULL__' }}"
                                        data-v2="{% if r|attr_default:g2 %}{{ r|attr_default:g2 }}{% else %}__NULL__{% endif %}">
                                  Fer grup independent
                                </button>
                              </div>

                              <button class="btn btn-sm btn-outline-secondary"
                                      onclick="event.stopPropagation(); toggleHeader('header-g2-{{ forloop.parentloop.counter0 }}-{{ forloop.counter }}')">
                                Oculta
                              </button>
                            </div>
                          </td>
                        </tr>
                      {% endifchanged %}
                    {% endif %}

                    {# HEADER g3 (sub-subagrupació) #}
                    {% if g3 %}
                      {% ifchanged r|attr:g3 %}
                        <tr class="group-row group-g3"
                            id="header-g3-{{ forloop.parentloop.counter0 }}-{{ forloop.counter }}"
                            data-label="{{ r|attr_default:g3|default:'(Sense valor)' }}">
                          <td colspan="10">
                            <div class="d-flex justify-content-between align-items-center">
                              <div class="d-flex align-items-center" style="gap:10px;">
                                <span class="font-weight-bold">{{ g3|capfirst }}:</span>
                                <span>{{ r|attr_default:g3|default:"(Sense valor)" }}</span>

                                <button type="button"
                                        class="btn btn-sm btn-outline-dark js-independent-group"
                                        data-lvl="g3"
                                        data-v1="{{ group|default:'__NULL__' }}"
                                        data-v2="{% if r|attr_default:g2 %}{{ r|attr_default:g2 }}{% else %}__NULL__{% endif %}"
                                        data-v3="{% if r|attr_default:g3 %}{{ r|attr_default:g3 }}{% else %}__NULL__{% endif %}">
                                  Fer grup independent
                                </button>
                              </div>

                              <button class="btn btn-sm btn-outline-secondary"
                                      onclick="event.stopPropagation(); toggleHeader('header-g3-{{ forloop.parentloop.counter0 }}-{{ forloop.counter }}')">
                                Oculta
                              </button>
                            </div>
                          </td>
                        </tr>
                      {% endifchanged %}
                    {% endif %}

                    {# FILA inscripció #}
                    <tr class="inscripcio-row" data-id="{{ r.id }}">
                      <td class="font-weight-bold">{{ r.nom_i_cognoms|default:"-" }}</td>
                      <td>{{ r.document|default:"-" }}</td>
                      <td>{{ r.sexe|default:"-" }}</td>
                      <td>{% if r.data_naixement %}{{ r.data_naixement|date:"d/m/Y" }}{% else %}-{% endif %}</td>
                      <td>{{ r.entitat|default:"-" }}</td>
                      <td>{{ r.categoria|default:"-" }}</td>
                      <td>{{ r.subcategoria|default:"-" }}</td>
                      <td>{{ r.grup|default:"-" }}</td>
                      <td>{{ r.ordre_sortida|default:"-" }}</td>
                      <td class="text-nowrap">
                        <a class="btn btn-sm btn-outline-primary"
                          href="{% url 'inscripcio_edit' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">Editar</a>
                        <a class="btn btn-sm btn-outline-danger"
                          href="{% url 'inscripcio_delete' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">Eliminar</a>
                      </td>
                    </tr>

                  {% endfor %}
                </tbody>
                {% endwith %}


              </table>
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <!-- Sense agrupació: mostra la taula normal -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Nom i cognoms</th>
              <th>DNI</th>
              <th>Sexe</th>
              <th>Data naixement</th>
              <th>Entitat</th>
              <th>Categoria</th>
              <th>Subcategoria</th>
              <th>Grup</th>
              <th>Ordre</th>
              <th>Accions</th>
            </tr>
          </thead>

          <tbody class="sortable-body" data-pane-id="__single__">
            {% for r in records %}
              <tr class="inscripcio-row" data-id="{{ r.id }}">
                <td class="font-weight-bold">{{ r.nom_i_cognoms|default:"-" }}</td>
                <td>{{ r.document|default:"-" }}</td>
                <td>{{ r.sexe|default:"-" }}</td>
                <td>{% if r.data_naixement %}{{ r.data_naixement|date:"d/m/Y" }}{% else %}-{% endif %}</td>
                <td>{{ r.entitat|default:"-" }}</td>
                <td>{{ r.categoria|default:"-" }}</td>
                <td>{{ r.subcategoria|default:"-" }}</td>
                <td>{{ r.grup|default:"-" }}</td>
                <td>{{ r.ordre_sortida|default:"-" }}</td>
                <td class="text-nowrap">
                  <a class="btn btn-sm btn-outline-primary"
                     href="{% url 'inscripcio_edit' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">
                    Editar
                  </a>
                  <a class="btn btn-sm btn-outline-danger"
                     href="{% url 'inscripcio_delete' competicio.id r.id %}?next={{ request.get_full_path|urlencode }}">
                    Eliminar
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted">
                  No hi ha inscripcions per aquesta competició
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% endif %}

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function hasTabs() {
    return !!document.querySelector('#tabs-root');
  }

  function collectGlobalIds() {
    const ids = [];

    if (hasTabs()) {
      const tabItems = Array.from(document.querySelectorAll('#tabs-root > li.nav-item'));
      tabItems.forEach(li => {
        const paneId = li.getAttribute('data-pane-id');
        if (!paneId) return;
        const tbody = document.querySelector(`#${paneId} tbody.sortable-body`);
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr.inscripcio-row'));
        rows.forEach(tr => tr.dataset?.id && ids.push(tr.dataset.id));
      });
      return ids;
    }

    const tbody = document.querySelector('tbody.sortable-body');
    if (!tbody) return ids;

    Array.from(tbody.querySelectorAll('tr.inscripcio-row')).forEach(tr => {
      tr.dataset?.id && ids.push(tr.dataset.id);
    });
    return ids;
  }

  async function saveGlobalOrder(movedId) {
    const ids = collectGlobalIds();
    if (!ids.length) return false;

    const newIndex = (movedId ? ids.indexOf(String(movedId)) : -1);

    const resp = await fetch("{% url 'inscripcions_reorder' competicio.id %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        ids: ids,
        moved_id: movedId ? String(movedId) : null,
        new_index: (newIndex >= 0 ? newIndex : null)
      })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      console.error("Error desant ordre:", resp.status, txt);
      alert(`No s'ha pogut desar l'ordre (${resp.status}).\n${txt}`);
      return false;
    }
    return true;
  }
  async function mergeTabs(sourceKey, targetKey) {
    if (!sourceKey || !targetKey || sourceKey === targetKey) return;

    const ok = confirm(`Vols fusionar:\n\n- ${sourceKey}\namb\n- ${targetKey}\n\nEs mostrarà com: "${targetKey} + ${sourceKey}"`);
    if (!ok) return;

    const resp = await fetch("{% url 'inscripcions_merge_tabs' competicio.id %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        group_field: "{{ selected_group_fields.0|default:'' }}",
        source_key: sourceKey,
        target_key: targetKey
      })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      alert(`No s'ha pogut fusionar (${resp.status}).\n${txt}`);
      return;
    }

    window.location.reload();
  }


  document.addEventListener('DOMContentLoaded', function() {
    // DEBUG ràpid (mira la consola)
    console.log("Sortable present?", typeof Sortable !== "undefined");

    // Si Sortable no ha carregat, parem aquí per evitar errors silenciosos
    if (typeof Sortable === "undefined") {
      console.error("SortableJS NO està carregat. Revisa la CDN o CSP.");
      return;
    }

    // Tabs Bootstrap 4 (això sí depèn de jQuery + bootstrap.js)
    // Ho fem “segur”: només ho activem si existeix jQuery
    if (window.jQuery) {
      window.jQuery('a[data-toggle="tab"]').on('click', function (e) {
        e.preventDefault();
        window.jQuery(this).tab('show');
      });
    } else {
      console.warn("jQuery no present: les pestanyes BS4 poden no funcionar.");
    }

    // 1) Sortable de pestanyes
    const tabsRoot = document.getElementById('tabs-root');
    if (tabsRoot) {
      new Sortable(tabsRoot, {
        animation: 150,
        draggable: 'li.nav-item',
        delay: 120,
        delayOnTouchOnly: true,
        forceFallback: true,
        fallbackOnBody: true,
        onEnd: async function(evt) {
          // Detecta si el drop s'ha fet sobre una altra pestanya
          const oe = evt.originalEvent;
          if (oe && typeof document.elementFromPoint === "function") {
            const el = document.elementFromPoint(oe.clientX, oe.clientY);
            const targetLi = el ? el.closest('#tabs-root > li.nav-item') : null;

            if (targetLi && targetLi !== evt.item) {
              const sourceKey = evt.item.getAttribute('data-group-key');
              const targetKey = targetLi.getAttribute('data-group-key');
              await mergeTabs(sourceKey, targetKey);
              return; // Important: NO fem reorder si hem fusionat
            }
          }

  // Si no hi ha fusió, fem reorder normal
  const ok = await saveGlobalOrder(null);
  if (ok) window.location.reload();
}

      });
    }

    function isHeaderRow(tr) {
      return tr && tr.classList.contains('group-row');
    }

    function headerLevel(tr) {
      if (!tr) return null;
      if (tr.classList.contains('group-g1')) return 'g1';
      if (tr.classList.contains('group-g2')) return 'g2';
      if (tr.classList.contains('group-g3')) return 'g3';
      return null;
    }

    // Bloc = header + tot fins abans del següent header del mateix nivell
    function getHeaderBlockRows(headerTr) {
      const lvl = headerLevel(headerTr);
      const rows = [headerTr];

      let cur = headerTr.nextElementSibling;
      while (cur) {
        if (isHeaderRow(cur) && lvl && cur.classList.contains('group-' + lvl)) break;
        rows.push(cur);
        cur = cur.nextElementSibling;
      }
      return rows;
    }

    document.querySelectorAll('tbody.sortable-body').forEach(function(tbody) {
      let draggedBlockRest = null;

      new Sortable(tbody, {
        animation: 150,
        draggable: 'tr.group-row, tr.inscripcio-row',
        filter: 'button, a, .hidden-tab',
        preventOnFilter: true,
        forceFallback: true,
        fallbackOnBody: true,

        onStart: function(evt) {
          const item = evt.item;
          if (isHeaderRow(item)) {
            const block = getHeaderBlockRows(item);
            draggedBlockRest = block.slice(1);
          } else {
            draggedBlockRest = null;
          }
        },

        onEnd: async function(evt) {
          const item = evt.item;

          // si s'arrossega un header, moure el bloc
          if (isHeaderRow(item) && draggedBlockRest && draggedBlockRest.length) {
            draggedBlockRest.forEach(r => r.parentNode && r.parentNode.removeChild(r));
            const frag = document.createDocumentFragment();
            draggedBlockRest.forEach(r => frag.appendChild(r));
            item.parentNode.insertBefore(frag, item.nextElementSibling);
            draggedBlockRest = null;
          }

          const movedId = (item && item.classList.contains('inscripcio-row')) ? item.dataset.id : null;
          const ok = await saveGlobalOrder(movedId);
          if (ok) window.location.reload();
        }

      });
    });


    console.log("Sortables inicialitzats:", document.querySelectorAll('tbody.sortable-body').length);
  });
</script>
{% endblock %}
