{% extends "base.html" %}
{% block title %}Configurar aparell - {{ competicio.nom }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card-surface">

    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-1">{% if object %}Editar{% else %}Afegir{% endif %} aparell</h2>
        <div class="text-muted small">{{ competicio.nom }}</div>
      </div>
      <div class="gap-2">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'aparell_create' %}">
          Crear aparell
        </a>
      </div>
    </div>

    <form method="post">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-warning">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="alert alert-warning">
          Revisa el formulari.
          {{ form.errors|striptags }}
        </div>
      {% endif %}

      <div class="border rounded p-3 mb-3">
        <div class="fw-semibold mb-2">Dades basiques</div>
        <div class="row g-3">
          <div class="col-12 col-md-8">
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label mb-0" for="{{ form.aparell.id_for_label }}">Aparell</label>
            </div>

            <div class="d-flex gap-2 align-items-start">
              <div class="flex-grow-1">
                {{ form.aparell }}
                {{ form.aparell.errors }}
              </div>
              <a
                id="puntuacio-link"
                class="btn btn-outline-secondary"
                data-url-template="{% url 'aparell_scoring_schema_update' pk=0 %}"
                href="#"
                style="display:none;"
              >Puntuacio</a>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label mb-0" for="{{ form.nombre_exercicis.id_for_label }}">Nombre d'Exercicis</label>
            </div>
            <span class="text-muted small">Selecciona el nombre d'exercicis o passades que els esportistes realitzaran en aquest aparell</span>
            <div class="d-flex gap-2 align-items-start">
              <div class="flex-grow-1">
                {{ form.nombre_exercicis }}
                {{ form.nombre_exercicis.errors }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="gap-2">
        <button class="btn btn-primary" type="submit">Desar</button>
        <a class="btn btn-outline-secondary"
           href="{{ request.GET.next|default:request.META.HTTP_REFERER }}">Cancelar</a>
      </div>
    </form>

  </div>
</div>

<script>
  (function () {
    var select = document.getElementById('{{ form.aparell.id_for_label }}');
    var link = document.getElementById('puntuacio-link');
    if (!select || !link) return;

    function updatePuntuacioLink() {
      var aparellId = select.value;
      if (!aparellId) {
        link.style.display = 'none';
        link.setAttribute('href', '#');
        return;
      }

      var urlTemplate = link.getAttribute('data-url-template');
      var href = urlTemplate.replace('/0/', '/' + aparellId + '/');
      var nextUrl = window.location.pathname + window.location.search;
      var sep = href.indexOf('?') === -1 ? '?' : '&';

      link.setAttribute('href', href + sep + 'next=' + encodeURIComponent(nextUrl));
      link.style.display = 'inline-block';
    }

    select.addEventListener('change', updatePuntuacioLink);
    updatePuntuacioLink();
  })();
</script>
{% endblock %}
