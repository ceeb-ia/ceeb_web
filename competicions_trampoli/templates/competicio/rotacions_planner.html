{% extends "base.html" %}
{% load static %}
{% block title %}Rotacions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .board { display:grid; grid-template-columns: 280px 1fr; gap:14px; }
    .cardx { background:#fff; border:1px solid #e3e6ef; border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .cardx-h { padding:12px 14px; border-bottom:1px solid #eef1f7; display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .cardx-b { padding:12px 14px; }

    .chip { display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; border-radius:999px; border:1px solid #cfd6e6; background:#f7f8fb; cursor:grab; user-select:none; font-weight:600; }
    .chip:active { cursor:grabbing; }
    .chip-muted { background:#fff; font-weight:500; color:#6b7280; }

    .grid-wrap { overflow:auto; border-radius:12px; }
    table.rot { border-collapse:separate; border-spacing:0; min-width:900px; }
    table.rot th, table.rot td { border:1px solid #e6e9f2; padding:10px; vertical-align:middle; text-align:center; }
    table.rot thead th { position:sticky; top:0; background:#fbfcff; z-index:2; }
    table.rot tbody th { position:sticky; left:0; background:#fbfcff; z-index:1; text-align:left; min-width:150px; width:150; }

    .cell { min-width:150px; height:56px; border-radius:10px; background:#ffffff; display:flex; align-items:center; justify-content:center; gap:8px; }
    .cell.is-over { outline:2px dashed #94a3b8; outline-offset:2px; background:#f8fafc; }
    .pill { padding:8px 10px; border-radius:12px; background:#111827; color:#fff; font-weight:700; }
    .pill.empty { background:#e5e7eb; color:#111827; font-weight:600; }

    .mini { font-size:.85rem; color:#6b7280; }
    .row-actions { display:flex; gap:8px; align-items:center; }
    .modal { z-index: 2000 !important; }
    .modal-backdrop { z-index: 1990 !important; }
    .grid-wrap{ overflow-x:auto; overflow-y:visible; position:relative; }
    .franja-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .franja-actions{
      display: grid;
      grid-template-columns: repeat(3, auto); /* m√†x. 3 per fila */
      grid-auto-rows: auto;
      gap: 4px;

      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease;
    }

    /* for√ßa que els dos primers ocupin la primera fila */
    .franja-actions > :nth-child(1),
    .franja-actions > :nth-child(2){
      grid-column: span 1;
    }

/* la resta baixen autom√†ticament a la segona fila */


    /* quan passes el ratol√≠ per la cel¬∑la/filera de la franja */
    tr:hover .franja-actions,
    th:hover .franja-actions{
      opacity:1;
      pointer-events:auto;
    }

    /* en pantalles t√†ctils: que sempre es vegin (no hi ha hover fiable) */
    @media (max-width: 768px){
      .franja-actions{
        opacity:1;
        pointer-events:auto;
      }
    }

</style>

  <div class="card-surface mb-3" style="border-radius:14px; border:1px solid #e3e6ef; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04);">
    <div class="d-flex justify-content-between align-items-start p-3 flex-wrap gap-3">
      <div>
        <h2 class="mb-1">Rotacions</h2>
        <div class="text-muted small">Competici√≥: <span class="fw-semibold">{{ competicio.nom }}</span></div>
        <div class="text-muted small">Arrossega grups a la graella i guarda el programa.</div>
      </div>
      <div class="gap-2 flex-wrap">
        <a href="{% url 'inscripcions_list' competicio.id %}" class="btn btn-sm btn-outline-primary">Inscripcions</a>
        <a href="{% url 'trampoli_config' competicio.id %}" class="btn btn-sm btn-outline-secondary">Configuraci√≥</a>
        <a href="{% url 'rotacions_franges_export_excel' competicio.id %}"
          class="btn btn-sm btn-outline-success">
          üìä Exportar horari a Excel
        </a>
      </div>
      </div>
    </div>
  </div>

  <div class="board">
    <!-- Sidebar -->
    <div class="cardx">
      <div class="cardx-h">
        <div>
          <div class="fw-semibold">Grups</div>
          <div class="mini">Drag & drop</div>
        </div>
        <span class="badge badge-light">{{ grups|length }}</span>
      </div>

      <div class="cardx-b">
        <div class="d-flex flex-wrap" style="gap:10px;">
          {% for g in grups %}
            <div class="chip" draggable="true" data-grup="{{ g }}">G{{ g }}</div>
          {% endfor %}
          <div class="chip chip-muted" draggable="true" data-grup="">(Buit)</div>
        </div>

        <hr class="my-3">

        <div class="fw-semibold mb-2">Afegir franja</div>
        <div class="d-flex" style="gap:8px; align-items:center; flex-wrap:wrap;">
          <input type="time" class="form-control form-control-sm" id="hi" style="width:130px;">
          <input type="time" class="form-control form-control-sm" id="hf" style="width:130px;">
          <input type="text" class="form-control form-control-sm" id="ft" placeholder="T√≠tol" style="flex:1; min-width:140px;">
          <button class="btn btn-sm btn-outline-dark" id="btnAddFranja">+</button>
        </div>
        <hr class="my-3">

        <div class="fw-semibold mb-2">Generar franges autom√†ticament</div>
        <div class="d-flex flex-column" style="gap:8px;">
        <div class="d-flex" style="gap:8px; flex-wrap:wrap;">
            <input type="time" class="form-control form-control-sm" id="auto_hi" style="width:130px;" placeholder="Inici">
            <input type="time" class="form-control form-control-sm" id="auto_hf" style="width:130px;" placeholder="Fi">
            <input type="number" class="form-control form-control-sm" id="auto_int" style="width:120px;" min="1" value="20" placeholder="Min">
        </div>

        <input type="text" class="form-control form-control-sm" id="auto_tb" value="Franja" placeholder="T√≠tol base (ex: Rotaci√≥)">

        <label class="mini" style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" id="auto_clear">
            Esborrar franges existents abans de generar
        </label>

        <button class="btn btn-sm btn-outline-primary" id="btnAutoFranges">
            Generar franges
        </button>

        <div class="mini" id="autoStatus"></div>
        </div>

        <hr class="my-3">

        <div class="fw-semibold mb-2">Afegir descans</div>
        <div class="d-flex" style="gap:8px; align-items:center;">
          <button class="btn btn-sm btn-outline-dark" id="btnAddDescans">+ Descans</button>
        </div>
      </div>
    </div>

    <!-- Grid -->
    <div class="cardx">
      <div class="cardx-h">
        <div class="fw-semibold">Programa (franges √ó estacions)</div>
            <div>
        <button class="btn btn-sm btn-outline-danger" id="btnClearAll" title="Netejar tot el programa">üßπ Netejar Programa</button>
    </div>

        <div class="mini">Tip: arrossega ‚Äú(Buit)‚Äù per esborrar una cel¬∑la</div>
      </div>

      <div class="cardx-b">
        <div class="grid-wrap">
          <table class="rot">
            <thead>
              <tr>
                <th>Franja</th>
                {% for a in estacions %}
                  <th class="js-col-h" draggable="true" data-estacio="{{ a.id }}">
                    <div class="d-flex justify-content-between align-items-center" style="gap:10px;">
                    <span>‚†ø {{ a.nom }}</span>
                    <button class="btn btn-sm btn-outline-danger py-0 px-2 js-del-es" data-es="{{ a.id }}" title="Eliminar estaci√≥">√ó</button>
                    </div>
                </th>
                {% endfor %}
              </tr>
            </thead>

            <tbody>
              {% for f in franges %}
                <tr>
                  <th>
                    <div class="franja-head">
                      <div class="franja-info">
                        <div class="fw-semibold">{{ f.titol|default:"Franja" }}</div>
                        <div class="mini">{{ f.hora_inici }} ‚Äì {{ f.hora_fi }}</div>
                      </div>

                      <div class="franja-actions">
                        <button class="btn btn-sm btn-light py-0 px-2 js-edit-fr"
                                data-url="{% url 'rotacions_franja_update_inline' competicio.id f.id %}"
                                data-titol="{{ f.titol|default_if_none:''|escape }}"
                                data-hi="{{ f.hora_inici|time:'H:i' }}"
                                data-hf="{{ f.hora_fi|time:'H:i' }}"
                                title="Editar">‚úèÔ∏è</button>

                        <button class="btn btn-sm btn-light py-0 px-2 js-insert-after"
                                data-fr="{{ f.id }}" title="Inserir despr√©s">Ôºã</button>
                        <button class="btn btn-sm btn-light py-0 px-2 js-clear-franja"
          data-fr="{{ f.id }}" title="Netejar franja">üßπ</button>

                        <button class="btn btn-sm btn-light py-0 px-2 js-extrapolar"
                                data-fr="{{ f.id }}" title="Extrapolar">‚á¢</button>

                        <button class="btn btn-sm btn-light py-0 px-2 text-danger js-del-fr"
                                data-fr="{{ f.id }}" title="Eliminar">üóë</button>
                      </div>
                    </div>

                  </th>

                  {% for a in estacions %}
                    <td>
                      <div class="cell js-cell" data-franja="{{ f.id }}" data-estacio="{{ a.id }}">
                        <span class="pill empty">‚Äî</span>
                      </div>
                    </td>
                  {% endfor %}
                </tr>
              {% empty %}
                <tr>
                  <td colspan="{{ estacions|length|add:1 }}" class="text-muted">
                    Encara no hi ha franges. Crea‚Äôn una a l‚Äôesquerra.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mini mt-2" id="saveStatus"></div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editFrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar franja</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Tancar"></button>
      </div>
      <div class="modal-body" style="display:flex; flex-direction:column; gap:10px;">
        <input type="text" class="form-control form-control-sm" id="editFrTitol" placeholder="T√≠tol">
        <div class="d-flex" style="gap:8px;">
          <input type="time" class="form-control form-control-sm" id="editFrHi">
          <input type="time" class="form-control form-control-sm" id="editFrHf">
        </div>
        <div class="mini text-muted">En desar, les franges seg√ºents s‚Äôajustaran autom√†ticament.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-outline-secondary" data-dismiss="modal">Cancel¬∑lar</button>
        <button class="btn btn-sm btn-primary" id="btnEditFrSave">Desar</button>
      </div>
    </div>
  </div>
</div>

<script id="grid-data" type="application/json">{{ grid_json|safe }}</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
(function($){
  if (!window.jQuery) return;

  function placeMenu($btn, $menu){
    var r = $btn[0].getBoundingClientRect();
    $menu.css({
      position: 'fixed',
      top: (r.bottom + 4) + 'px',
      left: (Math.max(8, r.right - $menu.outerWidth())) + 'px',
      zIndex: 3000,
      display: 'block'
    });
  }

  function cleanup($dd){
    var $menu = $dd.data('__menu');
    var $parent = $dd.data('__parent');
    var $next = $dd.data('__next');
    var $btn = $dd.data('__btn');

    if ($menu && $menu.length){
      $menu.removeClass('show').attr('style','');
      if ($parent && $parent.length){
        if ($next && $next.length) $next.before($menu);
        else $parent.append($menu);
      }
    }
    $dd.removeClass('show');
    if ($btn && $btn.length) $btn.attr('aria-expanded','false');

    // desactiva listeners globals
    $(document).off('mousedown.__griddd keydown.__griddd');
    $(window).off('scroll.__griddd resize.__griddd');
  }

  // Quan s'obre: mou el menu a body i prepara "tancar"
  $(document).on('show.bs.dropdown', '.grid-wrap .dropdown', function(){
    var $dd = $(this);
    var $btn = $dd.find('[data-toggle="dropdown"]').first();
    var $menu = $dd.find('.dropdown-menu').first();

    // guarda refer√®ncies exactes
    $dd.data('__btn', $btn);
    $dd.data('__menu', $menu);
    $dd.data('__parent', $menu.parent());
    $dd.data('__next', $menu.next());

    // mou a body
    $menu.detach().appendTo(document.body);

    // for√ßa estat "show" (perqu√® BS4 ho espera)
    $dd.addClass('show');
    $btn.attr('aria-expanded','true');
    $menu.addClass('show');

    placeMenu($btn, $menu);

    // tanca si fas click fora, ESC, scroll o resize
    $(document).on('mousedown.__griddd', function(e){
      if ($(e.target).closest($menu).length) return;         // clic dins el men√∫
      if ($(e.target).closest($btn).length) return;          // clic al toggle (BS4 ho gestiona)
      cleanup($dd);
    });

    $(document).on('keydown.__griddd', function(e){
      if (e.key === 'Escape') cleanup($dd);
    });

    $(window).on('scroll.__griddd resize.__griddd', function(){
      cleanup($dd);
    });
  });

  // Quan BS4 intenta tancar (p.ex. clic al toggle): reenganxa el men√∫ i neteja
  $(document).on('hide.bs.dropdown', '.grid-wrap .dropdown', function(){
    cleanup($(this));
  });

})(window.jQuery);
/* =========================
   ROTACIONS PLANNER JS (BS4)
   - Un sol DOMContentLoaded
   - Un sol click handler global
   - Un sol handler de "Desar" del modal
   - No interfereix amb dropdowns BS4
   ========================= */

// --- CSRF ---
function getCookie(name) {
  let v = null;
  if (document.cookie && document.cookie !== "") {
    for (const c of document.cookie.split(";")) {
      const x = c.trim();
      if (x.substring(0, name.length + 1) === (name + "=")) {
        v = decodeURIComponent(x.substring(name.length + 1));
        break;
      }
    }
  }
  return v;
}
const CSRF = getCookie("csrftoken");

// --- URLs ---
const SAVE_URL         = "{% url 'rotacions_save' competicio.id %}";
const ADD_FR_URL       = "{% url 'rotacions_franja_create' competicio.id %}";
const ADD_REST_URL     = "{% url 'rotacions_estacio_descans_create' competicio.id %}";
const AUTO_FR_URL      = "{% url 'rotacions_franges_auto_create' competicio.id %}";
const REORDER_COLS_URL = "{% url 'rotacions_estacions_reorder' competicio.id %}";
const CLEAR_ALL_URL    = "{% url 'rotacions_clear_all' competicio.id %}";
const INSERT_AFTER_URL = "{% url 'rotacions_franja_insert_after' competicio.id 0 %}";
const EXTRAPOLAR_URL0  = "{% url 'rotacions_extrapolar' competicio.id 0 %}";
const DEL_ES_URL0      = "{% url 'rotacions_estacio_delete' competicio.id 0 %}";
const DEL_FR_URL0      = "{% url 'rotacions_franja_delete' competicio.id 0 %}";

function insertAfterUrl(frId){
  return INSERT_AFTER_URL.replace("/0/", `/${frId}/`);
}
function extrapolarUrl(frId){
  // ruta tipus: /<id>/extrapolar/
  return EXTRAPOLAR_URL0.replace("/0/extrapolar/", `/${frId}/extrapolar/`);
}
function delEstacioUrl(id){
  return DEL_ES_URL0.replace("/0/", `/${id}/`);
}
function delFrUrl(id){
  return DEL_FR_URL0.replace("/0/delete/", `/${id}/delete/`);
}

// --- POST JSON ---
async function postJSON(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": CSRF
    },
    body: JSON.stringify(body || {}),
  });
  if (!res.ok) throw new Error(await res.text());
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await res.json();
  return null;
}

// --- UI helpers ---
function pillFor(grup){
  if (!grup) return `<span class="pill empty">‚Äî</span>`;
  return `<span class="pill">G${grup}</span>`;
}

// --- Estat local ---
let grid = {};
try {
  grid = JSON.parse(document.getElementById("grid-data")?.textContent || "{}");
} catch(e){
  grid = {};
}

// --- elements (poden no existir) ---
const statusEl = document.getElementById("saveStatus");
const autoStatusEl = document.getElementById("autoStatus");

// --- Autosave ---
async function autoSaveGrid() {
  const cells = [];
  for (const fr in grid) {
    for (const es in grid[fr]) {
      const g = grid[fr][es];
      cells.push({
        franja: parseInt(fr, 10),
        estacio: parseInt(es, 10),
        grup: (g == null ? "" : g),
      });
    }
  }

  if (statusEl) statusEl.textContent = "Guardant‚Ä¶";
  try {
    await postJSON(SAVE_URL, { cells });
    if (statusEl) statusEl.textContent = "‚úÖ Guardat.";
  } catch (e) {
    if (statusEl) statusEl.textContent = "‚ùå Error guardant: " + (e.message || e);
  }
}

function renderAll() {
  document.querySelectorAll(".js-cell").forEach((cell) => {
    const fr = cell.dataset.franja;
    const es = cell.dataset.estacio;
    const g = (grid[fr] && grid[fr][es] != null) ? grid[fr][es] : null;
    cell.innerHTML = pillFor(g);
  });
  // auto-save cada canvi
  autoSaveGrid();
}

// --- Column DnD (headers) ---
let dragColEstacioId = null;

function getColIndexByEstacioId(estacioId){
  const headers = Array.from(document.querySelectorAll("table.rot thead th.js-col-h"));
  return headers.findIndex(h => h.dataset.estacio === String(estacioId));
}

function moveColumn(fromIdx, toIdx){
  if (fromIdx === toIdx || fromIdx < 0 || toIdx < 0) return;
  const table = document.querySelector("table.rot");
  if (!table) return;

  const rows = Array.from(table.rows);
  rows.forEach((row) => {
    const cells = Array.from(row.cells);
    const a = cells[fromIdx + 1]; // +1 per saltar "Franja"
    const b = cells[toIdx + 1];
    if (!a || !b) return;

    if (fromIdx < toIdx) b.insertAdjacentElement("afterend", a);
    else b.insertAdjacentElement("beforebegin", a);
  });
}

async function persistColumnOrder(){
  const ids = Array.from(document.querySelectorAll("table.rot thead th.js-col-h"))
    .map(th => parseInt(th.dataset.estacio, 10))
    .filter(Boolean);

  await postJSON(REORDER_COLS_URL, {order: ids});
}

function initColumnDnD(){
  document.querySelectorAll("table.rot thead th.js-col-h").forEach((th) => {
    th.addEventListener("dragstart", (ev) => {
      dragColEstacioId = th.dataset.estacio;
      ev.dataTransfer.effectAllowed = "move";
      ev.dataTransfer.setData("text/plain", dragColEstacioId);
      th.style.opacity = "0.6";
    });

    th.addEventListener("dragend", () => {
      dragColEstacioId = null;
      th.style.opacity = "";
    });

    th.addEventListener("dragover", (ev) => {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = "move";
      th.style.outline = "2px dashed #94a3b8";
      th.style.outlineOffset = "2px";
    });

    th.addEventListener("dragleave", () => {
      th.style.outline = "";
      th.style.outlineOffset = "";
    });

    th.addEventListener("drop", async (ev) => {
      ev.preventDefault();
      th.style.outline = "";
      th.style.outlineOffset = "";

      const fromId = dragColEstacioId || ev.dataTransfer.getData("text/plain");
      const toId = th.dataset.estacio;
      if (!fromId || !toId || fromId === toId) return;

      const fromIdx = getColIndexByEstacioId(fromId);
      const toIdx = getColIndexByEstacioId(toId);

      moveColumn(fromIdx, toIdx);

      if (statusEl) statusEl.textContent = "Guardant ordre columnes‚Ä¶";
      try {
        await persistColumnOrder();
        if (statusEl) statusEl.textContent = "‚úÖ Ordre columnes guardat.";
      } catch(e){
        if (statusEl) statusEl.textContent = "‚ùå Error guardant ordre: " + (e.message || e);
      }
    });
  });
}

// --- Drag&Drop grups a cel¬∑les ---
function initCellDnD(){
  document.querySelectorAll(".chip[draggable='true']").forEach((chip) => {
    chip.addEventListener("dragstart", (ev) => {
      ev.dataTransfer.setData("text/plain", chip.dataset.grup ?? "");
    });
  });

  document.querySelectorAll(".js-cell").forEach((cell) => {
    cell.addEventListener("dragover", (ev) => {
      ev.preventDefault();
      cell.classList.add("is-over");
    });
    cell.addEventListener("dragleave", () => cell.classList.remove("is-over"));
    cell.addEventListener("drop", (ev) => {
      ev.preventDefault();
      cell.classList.remove("is-over");

      const grup = ev.dataTransfer.getData("text/plain"); // "" => buida
      const fr = cell.dataset.franja;
      const es = cell.dataset.estacio;

      if (!grid[fr]) grid[fr] = {};
      grid[fr][es] = (grup === "" ? null : parseInt(grup, 10));
      renderAll();
    });
  });
}

// --- Modal edici√≥ franja (BS4) ---
let editFrUrl = null;

function initEditModalPlacement(){
  const modalEl = document.getElementById("editFrModal");
  if (modalEl && modalEl.parentElement !== document.body){
    document.body.appendChild(modalEl);
  }
}

// --- Init controls (botons fora de la taula) ---
function initTopButtons(){
  const btnClearAll = document.getElementById("btnClearAll");
  if (btnClearAll) {
    btnClearAll.addEventListener("click", async () => {
      if (!confirm("Segur que vols netejar tot el programa? Aquesta acci√≥ no es pot desfer.")) return;

      if (statusEl) statusEl.textContent = "Netejant programa‚Ä¶";
      try {
        await postJSON(CLEAR_ALL_URL, {});
        grid = {};
        renderAll();
        if (statusEl) statusEl.textContent = "‚úÖ Programa netejat.";
        location.reload();
      } catch(e){
        if (statusEl) statusEl.textContent = "‚ùå Error netejant: " + (e.message || e);
      }
    });
  }

  const btnSave = document.getElementById("btnSave");
  if (btnSave) {
    btnSave.addEventListener("click", async () => {
      const cells = [];
      for (const fr in grid){
        for (const es in grid[fr]){
          const g = grid[fr][es];
          cells.push({
            franja: parseInt(fr, 10),
            estacio: parseInt(es, 10),
            grup: (g == null ? "" : g),
          });
        }
      }
      if (statusEl) statusEl.textContent = "Guardant‚Ä¶";
      try {
        await postJSON(SAVE_URL, {cells});
        if (statusEl) statusEl.textContent = "‚úÖ Guardat.";
      } catch(e){
        if (statusEl) statusEl.textContent = "‚ùå Error guardant: " + (e.message || e);
      }
    });
  }

  const btnAddFranja = document.getElementById("btnAddFranja");
  if (btnAddFranja) {
    btnAddFranja.addEventListener("click", async () => {
      const hora_inici = document.getElementById("hi")?.value;
      const hora_fi = document.getElementById("hf")?.value;
      const titol = document.getElementById("ft")?.value;
      try {
        await postJSON(ADD_FR_URL, {hora_inici, hora_fi, titol});
        location.reload();
      } catch(e){
        alert("Error creant franja: " + (e.message || e));
      }
    });
  }

  const btnAddDescans = document.getElementById("btnAddDescans");
  if (btnAddDescans) {
    btnAddDescans.addEventListener("click", async () => {
      try {
        await postJSON(ADD_REST_URL, {});
        location.reload();
      } catch(e){
        alert("Error creant descans: " + (e.message || e));
      }
    });
  }

  const btnAutoFranges = document.getElementById("btnAutoFranges");
  if (btnAutoFranges) {
    btnAutoFranges.addEventListener("click", async () => {
      const hora_inici = document.getElementById("auto_hi")?.value;
      const hora_fi = document.getElementById("auto_hf")?.value;
      const interval_min = parseInt(document.getElementById("auto_int")?.value || "0", 10);
      const titol_base = document.getElementById("auto_tb")?.value;
      const clear_existing = !!document.getElementById("auto_clear")?.checked;

      if (!hora_inici || !hora_fi || !interval_min || interval_min <= 0) {
        if (autoStatusEl) autoStatusEl.textContent = "‚ùå Omple inici, fi i interval (>0).";
        return;
      }

      if (autoStatusEl) autoStatusEl.textContent = "Generant‚Ä¶";
      try {
        const r = await postJSON(AUTO_FR_URL, {hora_inici, hora_fi, interval_min, titol_base, clear_existing});
        if (autoStatusEl) autoStatusEl.textContent = `‚úÖ Creat ${r && r.created != null ? r.created : ""} franges.`;
        location.reload();
      } catch (e) {
        if (autoStatusEl) autoStatusEl.textContent = "‚ùå Error: " + (e.message || e);
      }
    });
  }
}

// --- Click handler global (accions dins la taula) ---
function initGlobalClickHandler(){
  document.addEventListener("click", async (ev) => {
    // deixa que Bootstrap 4 obri dropdowns
    if (ev.target.closest('[data-toggle="dropdown"]')) return;

    // EDITAR FRANJA (obre modal)
    const editBtn = ev.target.closest(".js-edit-fr");
    if (editBtn){
      editFrUrl = editBtn.dataset.url;

      const t = document.getElementById("editFrTitol");
      const hi = document.getElementById("editFrHi");
      const hf = document.getElementById("editFrHf");

      if (t) t.value = editBtn.dataset.titol || "";
      if (hi) hi.value = editBtn.dataset.hi || "";
      if (hf) hf.value = editBtn.dataset.hf || "";

      if (window.jQuery) {
        window.jQuery("#editFrModal").modal("show");
      } else {
        alert("No hi ha jQuery carregat (Bootstrap 4 necessita jQuery).");
      }
      return;
    }

    // DESAR FRANJA (bot√≥ dins modal)
    const saveModalBtn = ev.target.closest("#btnEditFrSave");
    if (saveModalBtn){
      const titol = document.getElementById("editFrTitol")?.value || "";
      const hora_inici = document.getElementById("editFrHi")?.value || "";
      const hora_fi = document.getElementById("editFrHf")?.value || "";

      try{
        await postJSON(editFrUrl, {titol, hora_inici, hora_fi});
        if (window.jQuery) window.jQuery("#editFrModal").modal("hide");
        location.reload();
      } catch(e){
        alert("Error guardant franja: " + (e.message || e));
      }
      return;
    }

    // NETEJAR FRANJA (cel¬∑les a null)
    const clearBtn = ev.target.closest(".js-clear-franja");
    if (clearBtn && clearBtn.dataset.fr) {
      const frId = clearBtn.dataset.fr;
      if (!confirm("Netejar totes les caselles d'aquesta franja?")) return;
      if (!grid[frId]) grid[frId] = {};
      for (const es of Object.keys(grid[frId])) grid[frId][es] = null;
      renderAll();
      return;
    }

    // EXTRAPOLAR
    const exBtn = ev.target.closest(".js-extrapolar");
    const ex = exBtn?.dataset?.fr;
    if (ex){
      const countStr = prompt("Quantes franges seg√ºents vols omplir?", "");
      if (countStr === null) return;
      const count = (countStr.trim() === "") ? null : parseInt(countStr, 10);

      if (statusEl) statusEl.textContent = "Guardant i extrapolant‚Ä¶";

      try {
        // autosave abans
        const cells = [];
        for (const fr in grid){
          for (const es in grid[fr]){
            const g = grid[fr][es];
            cells.push({
              franja: parseInt(fr, 10),
              estacio: parseInt(es, 10),
              grup: (g == null ? "" : g),
            });
          }
        }
        await postJSON(SAVE_URL, {cells});

        const r = await postJSON(extrapolarUrl(ex), {count});
        if (statusEl) statusEl.textContent = `‚úÖ Extrapolat. Franges creades: ${r?.created_franges ?? "?"}, cel¬∑les omplertes: ${r?.filled ?? "?"}.`;
        location.reload();
      } catch(e){
        alert("Error extrapolant: " + (e.message || e));
        if (statusEl) statusEl.textContent = "‚ùå Error extrapolant: " + (e.message || e);
      }
      return;
    }

    // INSERT AFTER
    const insBtn = ev.target.closest(".js-insert-after");
    const ins = insBtn?.dataset?.fr;
    if (ins){
      try{
        await postJSON(insertAfterUrl(ins), {});
        location.reload();
      } catch(e){
        alert("Error inserint franja: " + (e.message || e));
      }
      return;
    }

    // DELETE FRANJA
    const delFrBtn = ev.target.closest(".js-del-fr");
    const fr = delFrBtn?.dataset?.fr;
    if (fr){
      if (!confirm("Eliminar franja?")) return;
      try {
        await postJSON(delFrUrl(fr), {});
        location.reload();
      } catch(e){
        alert(e.message || e);
      }
      return;
    }

    // DELETE ESTACI√ì
    const delEsBtn = ev.target.closest(".js-del-es");
    const es = delEsBtn?.dataset?.es;
    if (es){
      if (!confirm("Eliminar estaci√≥?")) return;
      try {
        await postJSON(delEstacioUrl(es), {});
        location.reload();
      } catch(e){
        alert(e.message || e);
      }
      return;
    }
  });
}

// --- INIT ---
document.addEventListener("DOMContentLoaded", () => {
  initEditModalPlacement();
  initColumnDnD();
  initCellDnD();
  initTopButtons();
  initGlobalClickHandler();

  renderAll();
});
</script>
{% endblock %}
