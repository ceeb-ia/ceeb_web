{% extends "base.html" %}
{% block title %}Jurat · QRs · {{ competicio.nom }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-1">Jurat · QRs</h2>
        <div class="text-muted small">
          Gestiona tokens i permisos de puntuació (sense admin).
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'scoring_notes_home' competicio.id %}">
          Tornar a notes
        </a>
      </div>
    </div>

    <form method="get" class="row g-2 align-items-end mb-3">
      <div class="col-auto">
        <label class="form-label small text-muted mb-1">Aparell</label>
        <select class="form-select form-select-sm" name="comp_aparell" onchange="this.form.submit()">
          {% for ca in comp_aparell_qs %}
            <option value="{{ ca.id }}" {% if comp_aparell and ca.id == comp_aparell.id %}selected{% endif %}>
              {{ ca.aparell.nom }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if comp_aparell %}
      <div class="col-auto">
        <a class="btn btn-sm btn-outline-primary"
           href="{% url 'judges_qr_print' competicio.id %}?comp_aparell={{ comp_aparell.id }}"
           target="_blank">
          Imprimir QRs
        </a>
      </div>
      {% endif %}
    </form>

    {% if not comp_aparell %}
      <div class="text-muted">No hi ha aparells actius configurats.</div>
    {% else %}

      <div class="row g-3">
        <!-- Crear token -->
        <div class="col-12 col-lg-6">
          <div class="card-surface">
            <h5 class="mb-2">Crear token</h5>

            {% if token_form.non_field_errors %}
              <div class="alert alert-danger py-2">
                {{ token_form.non_field_errors }}
              </div>
            {% endif %}

            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="create"/>

              <div class="mb-2">
                <label class="form-label small text-muted mb-1">Etiqueta</label>
                {{ token_form.label }}
              </div>

              <div class="mb-2">
                <div class="text-muted small mb-1">Permisos (pots posar varis camps al mateix token):</div>

                {{ formset.management_form }}

                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead>
                      <tr class="text-muted small">
                        <th style="min-width:240px;">Camp</th>
                        <th>Jutge</th>
                        <th>Start</th>
                        <th>Count</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="permTbody">
                      {% for f in formset.forms %}
                      <tr class="perm-row">
                        <td>{{ f.field_code }}</td>
                        <td>{{ f.judge_index }}</td>
                        <td>{{ f.item_start }}</td>
                        <td>{{ f.item_count }}</td>
                        <td class="text-end">
                          <div class="form-check">
                            {{ f.DELETE }}
                            <label class="form-check-label small text-muted">Eliminar</label>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

                <div class="text-muted small">
                  Notes: per camps tipus matrix (com E), Start/Count limita ítems. Per DD/TOF/HD/P (1 ítem) no cal.
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-sm btn-primary">Crear token</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Llista tokens -->
        <div class="col-12 col-lg-6">
          <div class="card-surface">
            <h5 class="mb-2">Tokens existents</h5>

            {% if tokens %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr class="text-muted small">
                      <th>Etiqueta</th>
                      <th>Permisos</th>
                      <th>QR</th>
                      <th class="text-end">Accions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for t in tokens %}
                      <tr>
                        <td style="min-width:170px;">
                          <div class="fw-semibold">{{ t.label|default:"(sense etiqueta)" }}</div>
                          <div class="text-muted small">{{ t.id }}</div>
                          {% if t.revoked_at %}
                            <div class="badge bg-danger">Revocat</div>
                          {% elif not t.is_active %}
                            <div class="badge bg-secondary">Inactiu</div>
                          {% else %}
                            <div class="badge bg-success">Actiu</div>
                          {% endif %}
                        </td>

                        <td class="text-muted small" style="min-width:220px;">
                          {% for p in t.permissions %}
                            <div>
                              <span class="badge bg-light text-dark">{{ p.field_code }}</span>
                              <span class="badge bg-light text-dark">J{{ p.judge_index }}</span>
                              {% if p.item_count %}
                                <span class="badge bg-light text-dark">{{ p.item_start }}..{{ p.item_start|add:p.item_count|add:"-1" }}</span>
                              {% endif %}
                            </div>
                          {% empty %}
                            —
                          {% endfor %}
                        </td>

                        <td>
                          <a class="btn btn-sm btn-outline-primary" href="{% url 'judge_portal' t.id %}" target="_blank">
                            Obrir
                          </a>
                          <a class="btn btn-sm btn-outline-secondary" href="{% url 'judge_qr_png' t.id %}" target="_blank">
                            QR
                          </a>
                        </td>

                        <td class="text-end">
                          {% if not t.revoked_at and t.is_active %}
                            <form method="post" style="display:inline;">
                              {% csrf_token %}
                              <input type="hidden" name="action" value="revoke"/>
                              <input type="hidden" name="token_id" value="{{ t.id }}"/>
                              <button class="btn btn-sm btn-outline-danger" type="submit">Revocar</button>
                            </form>
                          {% else %}
                            <span class="text-muted small">—</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted">Encara no hi ha tokens per aquest aparell.</div>
            {% endif %}
          </div>
        </div>
      </div>

    {% endif %}
  </div>
</div>
{% endblock %}