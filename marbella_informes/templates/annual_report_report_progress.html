{% extends "base.html" %}
{% block title %}Generant informe · {{ object }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card-surface p-3">
    <h2 class="mb-1">Generant informe</h2>
    <div class="text-muted small mb-3">{{ object }}</div>

    <div class="mb-2">
      <div class="text-muted small">Estat: <span id="status">{{ object.report_status }}</span></div>
      <div class="progress mt-2" style="height: 10px;">
        <div id="bar" class="progress-bar" role="progressbar" style="width: {{ object.report_progress }}%"></div>
      </div>
      <div class="text-muted small mt-1"><span id="pct">{{ object.report_progress }}</span>%</div>
    </div>

    <div id="err" class="alert alert-danger d-none mt-3"></div>

    <div class="mt-3 d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'annual_report_detail' object.pk %}">Tornar</a>
      <a class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener" href="{% url 'annual_report_pdf' object.pk %}">
        Veure PDF (render en directe)
      </a>
    </div>
  </div>
</div>

<script>
  async function poll() {
    const url = "{% url 'annual_report_report_progress_json' object.pk %}";
    const r = await fetch(url);
    const data = await r.json();

    document.getElementById("status").textContent = data.status || "";
    document.getElementById("pct").textContent = data.progress ?? 0;
    document.getElementById("bar").style.width = (data.progress ?? 0) + "%";

    const err = document.getElementById("err");
    if (data.error) {
      err.classList.remove("d-none");
      err.textContent = data.error;
      return;
    }

    // si ja està fet, redirigeix al detail
    if (data.status === "report_done" || (data.progress ?? 0) >= 100) {
      window.location.href = "{% url 'annual_report_detail' object.pk %}";
      return;
    }

    setTimeout(poll, 1500);
  }
  poll();
</script>
{% endblock %}
