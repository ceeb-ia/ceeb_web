{% extends "base.html" %}
{% block title %}Informes anuals{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <style>
    .card-surface { background:#fff; border-radius: 14px; border:1px solid #e3e6ef; padding:16px; }
    .report-card { border:1px solid #e8ebf5; border-radius: 12px; padding:14px; background:#fff; }
    .subtle { color:#6b7280; font-size:.85rem; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #cfd6e6; border-radius:999px; background:#fff; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
  </style>

  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 class="mb-1">Informes anuals</h2>
        <div class="text-muted small">Vista prèvia de tots els informes existents.</div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'annual_report_create' %}" class="btn btn-sm btn-primary">Nou informe</a>
      </div>
    </div>

    <form method="get" class="mb-3">
      <div class="form-row">
        <div class="col-md-4">
          <input name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="Cerca per instal·lació..." />
        </div>
        <div class="col-md-2">
          <button class="btn btn-sm btn-outline-secondary" type="submit">Cercar</button>
          {% if q %}
            <a class="btn btn-sm btn-link" href="{% url 'annual_report_list' %}">Netejar</a>
          {% endif %}
        </div>
      </div>
    </form>

    {% if reports %}
      <div class="table-responsive mb-3">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Any</th>
              <th>Instal·lació</th>
              <th>Datasets</th>
              <th>Actualitzat</th>
              <th style="width:220px;">Accions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reports %}
              <tr>
                <td class="text-nowrap">{{ r.any }}</td>
                <td>{{ r.instal_lacio_nom }}</td>
                <td>
                  <div class="chips">
                    {% for ds in r.datasets.all %}
                      {% if ds.fitxer %}
                        <span class="chip small">{{ ds.get_tipus_display }}</span>
                      {% endif %}
                    {% empty %}
                      <span class="text-muted small">—</span>
                    {% endfor %}
                  </div>
                </td>
                <td class="text-nowrap">{{ r.updated_at|date:"d/m/Y H:i" }}</td>
                <td class="text-nowrap">
                  <a class="btn btn-sm btn-outline-secondary" href="{% url 'annual_report_detail' r.pk %}">Veure</a>
                  <a class="btn btn-sm btn-primary" href="{% url 'annual_report_update' r.pk %}">Editar</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Vista prèvia en cards (opcional, però molt usable) -->
      <div class="d-flex flex-column gap-2">
        {% for r in reports %}
          <div class="report-card">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <h5 class="mb-0">{{ r.instal_lacio_nom }}</h5>
                  <span class="badge badge-light">{{ r.any }}</span>
                </div>
                <div class="subtle mt-1">
                  Actualitzat: {{ r.updated_at|date:"d/m/Y H:i" }}
                </div>

                <div class="chips mt-2">
                  {% for ds in r.datasets.all %}
                    {% if ds.fitxer %}
                      <span class="chip small">{{ ds.get_tipus_display }}</span>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>

              <div class=" gap-2 ">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'annual_report_detail' r.pk %}">Veure</a>
                <a class="btn btn-sm btn-primary" href="{% url 'annual_report_update' r.pk %}">Editar</a>
                <a class="btn btn-sm btn-success" href="#">Generar</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if is_paginated %}
        <nav class="mt-3">
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">Anterior</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">
                Pàgina {{ page_obj.number }} / {{ paginator.num_pages }}
              </span>
            </li>

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}">Següent</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Següent</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}

    {% else %}
      <div class="alert alert-info mb-0">
        Encara no hi ha informes. <a href="{% url 'annual_report_create' %}">Crea el primer</a>.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
