{% extends "base.html" %}

{% block title %}Designacions{% endblock %}

{% block content %}
<div class="card-surface container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Designacions</h2>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'designacions_runs_list' %}">
        Històric de runs
      </a>
    </div>


    <div id="status-message" class="alert" style="display:none;"></div>

    <form id="designacions-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="mb-3">
        <label class="form-label">
          Selecciona l'arxiu de disponibilitats i el de partits (.xlsx)
        </label>
        <input type="file" id="filesInput" name="files" class="form-control" accept=".xlsx" multiple required>

        <div class="form-text text-muted">
          Puja exactament 2 fitxers: disponibilitats (tutors) i partits.
        </div>
      </div>

      <div class="mb-3">
        <a class="btn btn-sm btn-outline-secondary" data-toggle="collapse" href="#advancedParams" role="button" aria-expanded="true" aria-controls="advancedParams">
          Paràmetres avançats
        </a>
      </div>

      <div class="collapse w-100 show" id="advancedParams">
        <div class="card w-100 show " style="max-width:100%">
          <div class="card-body container-fluid ">

          <div class="form-row row">
            <div class="form-group col-md-4">
              <label>Distància clústers (metres)</label>
              <input type="number" step="1" min="50" name="cluster_eps_m" class="form-control form-control-sm"
                    value="{{ defaults.cluster_eps_m }}">
              <small class="form-text text-muted">DBSCAN eps (radi màxim per agrupar seus properes).</small>
            </div>

            <div class="form-group col-md-4">
              <label>Min. punts per clúster</label>
              <input type="number" step="1" min="1" name="cluster_min_samples" class="form-control form-control-sm"
                    value="{{ defaults.cluster_min_samples }}">
            </div>

            <div class="form-group col-md-4">
              <label>Màx. partits per subgrup</label>
              <input type="number" step="1" min="1" name="max_partits_subgrup" class="form-control form-control-sm"
                    value="{{ defaults.max_partits_subgrup }}">
            </div>
          </div>

          <div class="form-row row">
            <div class="form-group col-md-6">
              <label>Llindar minuts (mateixa pista)</label>
              <input type="number" step="1" min="0" name="gap_same_pitch_min" class="form-control form-control-sm"
                    value="{{ defaults.gap_same_pitch_min }}">
            </div>
            <div class="form-group col-md-6">
              <label>Llindar minuts (pista diferent)</label>
              <input type="number" step="1" min="0" name="gap_diff_pitch_min" class="form-control form-control-sm"
                    value="{{ defaults.gap_diff_pitch_min }}">
            </div>
          </div>

          <div class="form-row row">
            <div class="form-group col-md-6">
              <label>Modalitats (selecció)</label>

              <select id="modalitatsSelect" name="modalitats_select" class="form-control form-control-sm" multiple size="6" disabled>
              </select>

              <small class="form-text text-muted">
                Selecciona els excels i es carregaran automàticament les modalitats del fitxer de partits.
              </small>

              <!-- Aquest hidden és el que realment enviem al backend -->
              <input type="hidden" name="modalitats_csv" id="modalitatsCsv" value="">
            </div>


            <div class="form-group col-md-3">
              <label>Data des de</label>
              <input type="date" name="date_from" class="form-control form-control-sm" value="{{ defaults.date_from }}">
            </div>

            <div class="form-group col-md-3">
              <label>Data fins a</label>
              <input type="date" name="date_to" class="form-control form-control-sm" value="{{ defaults.date_to }}">
            </div>
          </div>

          </div>
        </div>
      </div>


      <button type="submit" class="btn btn-primary btn-sm">
        Pujar i processar
      </button>
    </form>

    <div id="progress-section" class="mt-4 d-none">
      <h5 class="mb-2">Estat del procés</h5>
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="badge text-bg-secondary" id="progress-status">Iniciant...</span>
        <span class="text-muted small" id="progress-pct"></span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Logs</th>
            </tr>
          </thead>
          <tbody id="logs-tbody">
            <tr><td class="text-muted">Encara no hi ha logs...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="next-link" class="mt-3"></div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  function getCookie(name) {
    var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }

  var modalitatsSelect = document.getElementById('modalitatsSelect');
  var modalitatsCsv = document.getElementById('modalitatsCsv');

  // Canvia això segons el teu input:
  var filesInput = document.getElementById('filesInput');      // cas input múltiple
  var partitsFile = document.getElementById('partitsFile');    // cas input separat

  function setSelectOptions(items) {
    modalitatsSelect.innerHTML = "";
    items.forEach(function(m){
      var opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      modalitatsSelect.appendChild(opt);
    });
    modalitatsSelect.disabled = items.length === 0;
  }

  function updateHiddenFromSelect(){
    var selected = Array.from(modalitatsSelect.selectedOptions).map(o => o.value);
    modalitatsCsv.value = selected.join(", ");
  }

  if (modalitatsSelect) modalitatsSelect.addEventListener('change', updateHiddenFromSelect);

  async function fetchModalitats(file){
    if (!file) return;

    setSelectOptions([]);
    modalitatsSelect.disabled = true;

    var fd = new FormData();
    fd.append("partits_file", file);

    var resp = await fetch("{% url 'designacions_modalitats_preview' %}", {
      method: "POST",
      body: fd,
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      },
      credentials: "same-origin"
    });

    var data = await resp.json().catch(function(){ return {ok:false, error:"Resposta no vàlida"}; });

    if (!data.ok) {
      alert(data.error || "Error carregant modalitats");
      return;
    }

    setSelectOptions(data.modalitats || []);
    modalitatsSelect.disabled = false;

    // per defecte: selecciona totes (si vols que sigui buit, treu aquest bloc)
    Array.from(modalitatsSelect.options).forEach(o => o.selected = true);
    updateHiddenFromSelect();
  }

  // Cas input múltiple (2 fitxers al mateix input)
  if (filesInput) {
    filesInput.addEventListener('change', function(){
      var files = Array.from(filesInput.files || []);
      // Intentem detectar el fitxer de partits: si no ho podem saber, agafem el primer
      var f = files[0] || null;
      fetchModalitats(f);
    });
  }

  // Cas inputs separats
  if (partitsFile) {
    partitsFile.addEventListener('change', function(){
      fetchModalitats(partitsFile.files[0] || null);
    });
  }
})();

(function(){
  const form = document.getElementById('designacions-form');
  const progressSection = document.getElementById('progress-section');
  const statusBadge = document.getElementById('progress-status');
  const pctSpan = document.getElementById('progress-pct');
  const logsTbody = document.getElementById('logs-tbody');
  const nextLink = document.getElementById('next-link');

  let es = null;
  let lastProgress = null;

  function appendLog(msg){
    // si és el primer log, netegem placeholder
    if (logsTbody.querySelectorAll('tr').length === 1 &&
        logsTbody.innerText.includes('Encara no hi ha logs')) {
      logsTbody.innerHTML = '';
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${msg}</td>`;
    logsTbody.appendChild(tr);
  }

  function startLogStream(taskId){
    if (es) es.close();
    es = new EventSource(`/designacions/logs/${taskId}/stream`);
    es.onmessage = (e) => {
      try {
        const payload = JSON.parse(e.data); // {message, progress}
        if (payload.message) appendLog(payload.message);
        if (typeof payload.progress === 'number') {
          lastProgress = payload.progress;
          pctSpan.textContent = `${payload.progress}%`;
        }
      } catch(err) {
        appendLog(e.data);
      }
    };
    es.onerror = () => {
      // no tanquem: a vegades SSE falla puntualment
    };
  }

  async function pollStatus(taskId, runId){
    const r = await fetch(`/designacions/task-status/${taskId}/`);
    const data = await r.json();

    if (data.status === 'SUCCESS') {
      statusBadge.className = 'badge text-bg-success';
      statusBadge.textContent = 'Finalitzat';
      pctSpan.textContent = '100%';
      nextLink.innerHTML = `
        <a class="btn btn-sm btn-outline-primary"
           href="/designacions/run/${runId}/assignments/">
          Veure i editar assignacions
        </a>`;
      if (es) es.close();
      return;
    }

    if (data.status === 'FAILURE') {
      statusBadge.className = 'badge text-bg-danger';
      statusBadge.textContent = 'Error';
      appendLog('ERROR: ' + (data.error || 'Desconegut'));
      if (es) es.close();
      return;
    }

    statusBadge.className = 'badge text-bg-secondary';
    statusBadge.textContent = data.status || 'En curs';
    setTimeout(() => pollStatus(taskId, runId), 1500);
  }

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const resp = await fetch("", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: formData
    });

    if (!resp.ok) {
      appendLog("Error en pujar fitxers.");
      return;
    }

    // El POST retorna redirect al run_detail (com et vaig passar abans),
    // així que aquí fem una petita adaptació:
    // Si prefereixes resposta JSON, t'ho canvio. Ara ho fem via Location.
    const runUrl = resp.url; // URL final després de redirect
    // suposem format .../designacions/run/<id>/
    const m = runUrl.match(/\/designacions\/run\/(\d+)\//);
    const runId = m ? m[1] : null;

    // fem reload al run_detail (que ja porta task_id). Més simple:
    window.location.href = runUrl;
  });
})();
</script>
{% endblock %}
