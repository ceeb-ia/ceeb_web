{% extends "base.html" %}

{% block title %}Designacions{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card-surface">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Designacions</h2>
    </div>

    <div id="status-message" class="alert" style="display:none;"></div>

    <form id="designacions-form" method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="mb-3">
        <label class="form-label">
          Selecciona l'arxiu de disponibilitats i el de partits (.xlsx)
        </label>
        <input type="file" id="files" name="files" class="form-control" multiple accept=".xlsx">
        <div class="form-text text-muted">
          Puja exactament 2 fitxers: disponibilitats (tutors) i partits.
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-sm">
        Pujar i processar
      </button>
    </form>

    <div id="progress-section" class="mt-4 d-none">
      <h5 class="mb-2">Estat del procés</h5>
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="badge text-bg-secondary" id="progress-status">Iniciant...</span>
        <span class="text-muted small" id="progress-pct"></span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Logs</th>
            </tr>
          </thead>
          <tbody id="logs-tbody">
            <tr><td class="text-muted">Encara no hi ha logs...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="next-link" class="mt-3"></div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const form = document.getElementById('designacions-form');
  const progressSection = document.getElementById('progress-section');
  const statusBadge = document.getElementById('progress-status');
  const pctSpan = document.getElementById('progress-pct');
  const logsTbody = document.getElementById('logs-tbody');
  const nextLink = document.getElementById('next-link');

  let es = null;
  let lastProgress = null;

  function appendLog(msg){
    // si és el primer log, netegem placeholder
    if (logsTbody.querySelectorAll('tr').length === 1 &&
        logsTbody.innerText.includes('Encara no hi ha logs')) {
      logsTbody.innerHTML = '';
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${msg}</td>`;
    logsTbody.appendChild(tr);
  }

  function startLogStream(taskId){
    if (es) es.close();
    es = new EventSource(`/designacions/logs/${taskId}/stream`);
    es.onmessage = (e) => {
      try {
        const payload = JSON.parse(e.data); // {message, progress}
        if (payload.message) appendLog(payload.message);
        if (typeof payload.progress === 'number') {
          lastProgress = payload.progress;
          pctSpan.textContent = `${payload.progress}%`;
        }
      } catch(err) {
        appendLog(e.data);
      }
    };
    es.onerror = () => {
      // no tanquem: a vegades SSE falla puntualment
    };
  }

  async function pollStatus(taskId, runId){
    const r = await fetch(`/designacions/task-status/${taskId}/`);
    const data = await r.json();

    if (data.status === 'SUCCESS') {
      statusBadge.className = 'badge text-bg-success';
      statusBadge.textContent = 'Finalitzat';
      pctSpan.textContent = '100%';
      nextLink.innerHTML = `
        <a class="btn btn-sm btn-outline-primary"
           href="/designacions/run/${runId}/assignments/">
          Veure i editar assignacions
        </a>`;
      if (es) es.close();
      return;
    }

    if (data.status === 'FAILURE') {
      statusBadge.className = 'badge text-bg-danger';
      statusBadge.textContent = 'Error';
      appendLog('ERROR: ' + (data.error || 'Desconegut'));
      if (es) es.close();
      return;
    }

    statusBadge.className = 'badge text-bg-secondary';
    statusBadge.textContent = data.status || 'En curs';
    setTimeout(() => pollStatus(taskId, runId), 1500);
  }

  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = new FormData(form);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const resp = await fetch("", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: formData
    });

    if (!resp.ok) {
      appendLog("Error en pujar fitxers.");
      return;
    }

    // El POST retorna redirect al run_detail (com et vaig passar abans),
    // així que aquí fem una petita adaptació:
    // Si prefereixes resposta JSON, t'ho canvio. Ara ho fem via Location.
    const runUrl = resp.url; // URL final després de redirect
    // suposem format .../designacions/run/<id>/
    const m = runUrl.match(/\/designacions\/run\/(\d+)\//);
    const runId = m ? m[1] : null;

    // fem reload al run_detail (que ja porta task_id). Més simple:
    window.location.href = runUrl;
  });
})();
</script>
{% endblock %}
