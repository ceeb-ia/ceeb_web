{% extends "base.html" %}
{% block title %}Designacions - Execució {{ run.id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card-surface p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Execució #{{ run.id }}</h2>
        <div class="text-muted small">Task: {{ run.task_id }}</div>
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'designacions_upload' %}">Nova execució</a>
    </div>

    <div class="d-flex align-items-center gap-2 mb-2">
      <span class="badge text-bg-secondary" id="progress-status">En curs</span>
      <span class="text-muted small" id="progress-pct"></span>
    </div>

    <div class="progress mb-3" style="height: 10px;">
      <div class="progress-bar" id="progress-bar" role="progressbar" style="width:0%"></div>
    </div>

    <div class="row g-2 mb-3">
      <div class="col-12 col-lg-8">
        <div class="border rounded p-3">
          <div class="fw-bold mb-2">Passos</div>
          <ol class="mb-0" id="steps">
            <li><span class="step-badge badge text-bg-secondary me-2" data-step="import">...</span> Important Excels</li>
            <li><span class="step-badge badge text-bg-secondary me-2" data-step="engine">...</span> Executant motor</li>
            <li><span class="step-badge badge text-bg-secondary me-2" data-step="map">...</span> Generant mapa</li>
            <li><span class="step-badge badge text-bg-secondary me-2" data-step="done">...</span> Finalitzant</li>
          </ol>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="border rounded p-3 h-100">
          <div class="fw-bold mb-2">Accions</div>
          <div id="next-link" class="d-grid gap-2"></div>
        </div>
      </div>
    </div>

    <div class="accordion" id="logsAcc">
      <div class="accordion-item">
        <h2 class="accordion-header" id="logsHead">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#logsBody">
            Detalls tècnics (logs)
          </button>
        </h2>
        <div id="logsBody" class="accordion-collapse collapse" data-bs-parent="#logsAcc">
          <div class="accordion-body">
            <div class="table-responsive">
              <table class="table table-striped table-bordered table-sm align-middle mb-0">
                <thead class="table-light"><tr><th>Logs</th></tr></thead>
                <tbody id="logs-tbody">
                  <tr><td class="text-muted">Connectant.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function(){
  const taskId = "{{ run.task_id }}";
  const runId = "{{ run.id }}";

  const statusBadge = document.getElementById('progress-status');
  const pctSpan = document.getElementById('progress-pct');
  const progressBar = document.getElementById('progress-bar');
  const logsTbody = document.getElementById('logs-tbody');
  const nextLink = document.getElementById('next-link');

  const stepBadges = {
    import: document.querySelector('[data-step="import"]'),
    engine: document.querySelector('[data-step="engine"]'),
    map: document.querySelector('[data-step="map"]'),
    done: document.querySelector('[data-step="done"]')
  };

  let es = null;
  let lastProgress = 0;

  function setStep(stepKey, state){
    // state: "todo" | "doing" | "done"
    const b = stepBadges[stepKey];
    if(!b) return;
    if (state === "done") { b.className = "step-badge badge text-bg-success me-2"; b.textContent = "✓"; }
    else if (state === "doing") { b.className = "step-badge badge text-bg-primary me-2"; b.textContent = "…"; }
    else { b.className = "step-badge badge text-bg-secondary me-2"; b.textContent = "·"; }
  }

  function appendLog(msg){
    if (logsTbody.querySelectorAll('tr').length === 1 && logsTbody.innerText.includes('Connectant')) {
      logsTbody.innerHTML = '';
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${msg}</td>`;
    logsTbody.appendChild(tr);
  }

  function updateUIFromMessage(message, progress){
    if (typeof progress === "number") {
      lastProgress = progress;
      pctSpan.textContent = `${progress}%`;
      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }

    // Heurística simple per passos segons el text
    const m = (message || "").toLowerCase();
    setStep("import", "doing");
    if (m.includes("import ok") || m.includes("important excels")) setStep("import", "doing");
    if (lastProgress >= 25) setStep("import", "done");

    if (m.includes("executant motor") || lastProgress >= 35) setStep("engine", "doing");
    if (lastProgress >= 80) setStep("engine", "done");

    if (m.includes("mapa") || lastProgress >= 92) setStep("map", "doing");
    if (lastProgress >= 95) setStep("map", "done");

    if (lastProgress >= 99) setStep("done", "doing");
  }

  function startLogStream(){
    if (es) es.close();
    es = new EventSource(`/designacions/logs/${taskId}/stream`);
    es.onmessage = (e) => {
      try {
        const payload = JSON.parse(e.data); // {message, progress}
        if (payload.message) appendLog(payload.message);
        updateUIFromMessage(payload.message, payload.progress);
      } catch(err) {
        appendLog(e.data);
      }
    };
  }

  async function poll(){
    const r = await fetch(`/designacions/task-status/${taskId}/`);
    const data = await r.json();

    if (data.status === 'SUCCESS') {
      statusBadge.className = 'badge text-bg-success';
      statusBadge.textContent = 'Finalitzat';
      pctSpan.textContent = '100%';
      progressBar.style.width = '100%';
      setStep("import","done"); setStep("engine","done"); setStep("map","done"); setStep("done","done");

      nextLink.innerHTML = `
        <a class="btn btn-sm btn-outline-primary" href="/designacions/run/${runId}/assignments/">
          Veure i editar assignacions
        </a>
      `;
      if (es) es.close();
      return;
    }

    if (data.status === 'FAILURE') {
      statusBadge.className = 'badge text-bg-danger';
      statusBadge.textContent = 'Error';
      appendLog('ERROR: ' + (data.error || 'Desconegut'));
      if (es) es.close();
      return;
    }

    statusBadge.className = 'badge text-bg-secondary';
    statusBadge.textContent = data.status || 'En curs';
    setTimeout(poll, 1500);
  }

  // init
  setStep("import","todo"); setStep("engine","todo"); setStep("map","todo"); setStep("done","todo");
  startLogStream();
  poll();
})();
</script>
{% endblock %}
